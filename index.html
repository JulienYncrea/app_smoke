<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmokeTrack üö≠</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.png" />
    <meta name="theme-color" content="#111827" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #000000; /* Fond noir comme demand√© */
            color: #f9fafb;
            line-height: 1.6;
        }
        h1, h2, h3 {
            text-align: center;
            color: #4CAF50; /* Vert pour la sant√© */
            margin-bottom: 1rem;
        }
        #mainTitle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            color: #4CAF50;
            cursor: pointer;
            font-size: 2em;
            margin-bottom: 1rem;
        }
        #mainTitle .logo {
            font-size: 1.2em;
        }

        /* Styles for navigation buttons */
        .nav-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px; /* Taille par d√©faut */
            height: 80px; /* Taille par d√©faut */
            border-radius: 50%;
            background: #2563eb; /* Blue for navigation */
            color: #ffffff;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.8em; /* Taille de police par d√©faut */
            text-align: center;
            padding: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.1s ease;
            border: none; /* Ensure no default button border */
            cursor: pointer;
        }

        .nav-button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .nav-button:active, .nav-button.active {
            background: #1d4ed8; /* Darker blue for active state */
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3); /* Inner shadow for pressed effect */
        }

        .nav-button .icon {
            font-size: 1.8em; /* Taille d'ic√¥ne par d√©faut */
            margin-bottom: 0.2em;
        }

        /* View sections visibility */
        .view-section {
            display: none; /* Hidden by default */
        }

        .view-section.active {
            display: block; /* Shown when active */
        }

        .container {
            max-width: 600px;
            margin: 1rem auto;
            background: #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        label {
            display: block;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #E0E7FF;
        }
        input[type="date"],
        input[type="number"],
        button,
        select {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.2rem;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            box-sizing: border-box;
            background: #4B5563;
            color: #f9fafb;
            font-size: 1rem;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        button[type="submit"], button.btn-action { /* Adjusted to target specific buttons */
            margin-top: 1.5rem;
            background: #4CAF50; /* Vert */
            color: #ffffff;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-size: 1.1rem;
            border: none;
        }
        button[type="submit"]:hover, button.btn-action:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        button[type="submit"]:active, button.btn.btn-action:active {
            transform: translateY(0);
        }

        .record-item {
            background: #111827;
            padding: 0.8rem 1.2rem;
            margin-top: 0.7rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-left: 5px solid #4CAF50;
        }
        .record-item:hover {
            background: #2563eb;
        }
        .record-item span {
            font-size: 1rem;
            color: #d1d5db;
        }
        .record-item .date {
            font-weight: bold;
            color: #FBBF24;
            flex-basis: 30%;
        }
        .record-item .count {
            font-weight: bold;
            color: #E0E7FF;
            flex-basis: 30%;
            text-align: right;
        }
        .record-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }
        .btn-action {
            background: #ef4444; /* Rouge pour supprimer */
            border: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            transition: background-color 0.3s ease;
            margin-top: 0; /* Override global margin-top for action buttons */
        }
        .btn-action:hover {
            background: #b91c1c;
        }
        .btn-edit {
            background: #3b82f6; /* Bleu pour modifier */
        }
        .btn-edit:hover {
            background: #1d4ed8;
        }

        .stats-section {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border-bottom: 4px solid #4CAF50;
        }
        .stat-card h3 {
            color: #FBBF24;
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.2em;
        }
        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: #E0E7FF;
            margin: 0;
        }

        .chart-container {
            margin-top: 2rem;
            max-height: 400px; /* Revert√© comme demand√© */
            overflow: hidden; /* Revert√© comme demand√© */
        }
        /* Style for the chart titles that are INSIDE the grey container, below the canvas */
        .chart-container h2 {
            text-align: center;
            color: #4CAF50;
            margin-top: 1rem; /* Adjusted margin to place below canvas */
            margin-bottom: 1rem;
        }
        /* Style for the new main titles OUTSIDE the grey containers */
        .chart-main-title {
            text-align: center;
            color: #FBBF24; /* Yellow for main chart titles */
            margin-top: 2rem; /* More space above */
            margin-bottom: 1rem; /* Space below */
            font-size: 1.8em; /* Larger font size */
        }

        /* Enforce canvas height and display */
        #dailyChart, #weeklyChart, #monthlyChart {
            max-width: 100%;
            height: 300px; /* Fixed height for charts */
            background: #111827;
            padding: 1rem; /* Padding applied to canvas, not its container */
            border-radius: 0.5rem;
            display: block; /* Ensures canvas respects its dimensions */
            margin: 0 auto; /* Center the canvas if it doesn't take full width */
        }

        /* Styles for increment/decrement buttons */
        .count-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .count-input-group input[type="number"] {
            flex-grow: 1; /* Allows the input to take available space */
            margin-top: 0; /* Remove default margin-top from global input rule */
            max-width: 100px;

        }
        .count-input-group .count-button {
            width: 40px; /* Fixed width for buttons */
            height: 40px; /* Fixed height for buttons */
            padding: 0; /* Remove padding */
            margin-top: 0; /* Remove default margin-top */
            font-size: 1.5rem;
            line-height: 1; /* Center content vertically */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            background: #4CAF50; /* Green */
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .count-input-group .count-button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        .count-input-group .count-button:active {
            transform: translateY(0);
        }
        .count-input-group .count-button.decrement {
            background: #ef4444; /* Red for decrement */
        }
        .count-input-group .count-button.decrement:hover {
            background: #b91c1c;
        }


        @media (max-width: 640px) {
            .container {
                padding: 1rem;
                margin: 0.5rem auto;
            }
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .record-item .date, .record-item .count {
                flex-basis: 100%;
                text-align: left;
            }
            .record-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
            }
            /* Stats cards smaller on mobile and 2 columns */
            .stats-section {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* 2 colonnes pour les statistiques */
                gap: 0.5rem; /* Espacement r√©duit */
            }
            .stat-card {
                padding: 0.5rem; /* R√©duire le padding encore */
            }
            .stat-card h3 {
                font-size: 0.9em; /* Texte encore plus petit pour les titres */
            }
            .stat-card p {
                font-size: 1.3em; /* Texte encore plus petit pour les valeurs */
            }

            .count-input-group {
                flex-wrap: nowrap; /* Emp√™che le retour √† la ligne des boutons */
            }
            .count-input-group input[type="number"] {
                width: auto; 
            }
            .nav-buttons-container {
                align-items: center; 
                gap: 0.5rem; 
            }
            .nav-button {
                width: 65px; 
                height: 65px; 
                font-size: 0.65em; /* Texte des boutons encore plus petit */
            }
            .nav-button .icon {
                font-size: 1.5em; /* Ic√¥ne l√©g√®rement plus petite */
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Service Worker Registration (for PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker enregistr√©:', reg.scope))
                    .catch(err => console.error('Erreur SW:', err));
            });
        }
    </script>
</head>
<body>
    <h1 id="mainTitle">SmokeTrack <span class="logo">üö≠</span></h1>

    <div class="nav-buttons-container">
        <button class="nav-button active" data-target="consumptionView">
            <span class="icon">üö¨</span>
            Consommation
        </button>
        <button class="nav-button" data-target="historyView">
            <span class="icon">üìú</span>
            Historique
        </button>
        <button class="nav-button" data-target="trendsView">
            <span class="icon">üìà</span>
            Tendances
        </button>
    </div>

    <div id="consumptionView" class="view-section active">
        <div class="container">
            <h2>Add your consumption</h2>
            <form id="cigaretteForm">
                <label for="recordDate">Date</label>
                <input type="date" id="recordDate" required />

                <label for="cigaretteCount">Nombre de cigarettes</label>
                <div class="count-input-group">
                    <button type="button" id="decrementCount" class="count-button decrement">-</button>
                    <input type="number" id="cigaretteCount" min="0" value="0" required />
                    <button type="button" id="incrementCount" class="count-button">+</button>
                </div>

                </form>
        </div>

        <div class="container stats-section">
            <div class="stat-card">
                <h3>Moyenne quotidienne (7j)</h3>
                <p id="avgDailyLast7Days">0</p>
            </div>
            <div class="stat-card">
                <h3>Total aujourd'hui</h3>
                <p id="totalToday">0</p>
            </div>
            <div class="stat-card">
                <h3>Total cette semaine</h3>
                <p id="totalThisWeek">0</p>
            </div>
            <div class="stat-card">
                <h3>Total ce mois</h3>
                <p id="totalThisMonth">0</p>
            </div>
            <div class="stat-card">
                <h3>Total g√©n√©ral</h3>
                <p id="totalCigarettesSmoked">0</p>
            </div>
        </div>
    </div>

    <div id="historyView" class="view-section">
        <div class="container">
            <h2>Historique des consommations</h2>
            <div id="recordList">
                </div>
        </div>
    </div>

    <div id="trendsView" class="view-section">
        <h2 class="chart-main-title">Tendances de consommation journali√®re</h2>
        <div class="container chart-container">
            <canvas id="dailyChart"></canvas>
            <h2>Tendances journali√®res (30 derniers jours)</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation hebdomadaire</h2>
        <div class="container chart-container">
            <canvas id="weeklyChart"></canvas>
            <h2>Tendances hebdomadaires</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation mensuelle</h2>
        <div class="container chart-container">
            <canvas id="monthlyChart"></canvas>
            <h2>Tendances mensuelles</h2>
        </div>
    </div>

    <script>
        const cigaretteForm = document.getElementById('cigaretteForm');
        const recordDateInput = document.getElementById('recordDate');
        const cigaretteCountInput = document.getElementById('cigaretteCount');
        const recordList = document.getElementById('recordList');
        const mainTitle = document.getElementById('mainTitle');
        const incrementButton = document.getElementById('incrementCount');
        const decrementButton = document.getElementById('decrementCount');

        // Stats elements
        const avgDailyLast7DaysElement = document.getElementById('avgDailyLast7Days');
        const totalTodayElement = document.getElementById('totalToday');
        const totalThisWeekElement = document.getElementById('totalThisWeek');
        const totalThisMonthElement = document.getElementById('totalThisMonth');
        const totalCigarettesSmokedElement = document.getElementById('totalCigarettesSmoked'); // Nouveau : total g√©n√©ral

        // Navigation elements
        const navButtons = document.querySelectorAll('.nav-button');
        const viewSections = document.querySelectorAll('.view-section');

        let records = [];

        // Chart instances
        let dailyChartInstance = null;
        let weeklyChartInstance = null;
        let monthlyChartInstance = null;

        // Data holders for charts
        let chartData = {
            dailyLabels: [], dailyCounts: [],
            weeklyLabels: [], weeklyCounts: [],
            monthlyLabels: [], monthlyCounts: []
        };

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function loadRecords() {
            const storedRecords = JSON.parse(localStorage.getItem('smokeTrackRecords')) || [];
            records = [];
            let changed = false;

            // Ensure all records have an ID and filter out 0-count records
            storedRecords.forEach(record => {
                if (!record.id) {
                    record.id = generateUniqueId();
                    changed = true;
                }
                if (record.count > 0) { // Only keep records with count > 0
                    records.push(record);
                } else {
                    changed = true; // Mark as changed if a 0-count record was removed
                }
            });

            if (changed) {
                localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            }

            // Sort records by date descending for display
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            displayRecords();
            updateStatistics();
            prepareChartData(); // Prepare chart data after records are loaded/updated
        }

        function displayRecords() {
            recordList.innerHTML = '';
            if (records.length === 0) {
                recordList.innerHTML = '<p style="text-align: center; color: #d1d5db;">Aucune consommation enregistr√©e pour le moment.</p>';
                return;
            }

            records.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.dataset.id = record.id;

                div.innerHTML = `
                    <span class="date">${formatDate(record.date)}</span>
                    <span class="count">${record.count} cigarette(s)</span>
                    <div class="record-actions">
                        <button class="btn-action btn-edit" data-id="${record.id}" title="Modifier cet enregistrement">‚úèÔ∏è Modifier</button>
                        <button class="btn-action btn-delete" data-id="${record.id}" title="Supprimer cet enregistrement">üóëÔ∏è Supprimer</button>
                    </div>
                `;

                const btnDelete = div.querySelector('.btn-delete');
                const btnEdit = div.querySelector('.btn-edit');

                btnDelete.addEventListener('click', e => {
                    e.stopPropagation();
                    const recordIdToDelete = e.target.dataset.id;
                    const recordToDelete = records.find(r => r.id === recordIdToDelete);
                    if (confirm(`Supprimer l'enregistrement du ${formatDate(recordToDelete.date)} (${recordToDelete.count} cigarettes) ?`)) {
                        records = records.filter(r => r.id !== recordIdToDelete);
                        localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
                        loadRecords(); // Reload to update list, stats, and charts
                        // If the deleted record was for the currently selected date, reset consumption view
                        if (recordDateInput.value === recordToDelete.date) {
                            cigaretteCountInput.value = 0;
                        }
                    }
                });

                btnEdit.addEventListener('click', e => {
                    e.stopPropagation();
                    const recordIdToEdit = e.target.dataset.id;
                    const recordToEdit = records.find(r => r.id === recordIdToEdit);

                    if (recordToEdit) {
                        recordDateInput.value = recordToEdit.date;
                        cigaretteCountInput.value = recordToEdit.count;
                        showView('consumptionView'); // Switch to consumption view for editing
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of the view
                    }
                });

                recordList.appendChild(div);
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            // Adjust for timezone offset to prevent date shifting for local storage dates
            const userTimezoneOffset = d.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
            return adjustedDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Nouvelle fonction pour enregistrer ou mettre √† jour la consommation
        function saveOrUpdateConsumption() {
            const date = recordDateInput.value;
            const count = parseInt(cigaretteCountInput.value, 10);

            if (!date) {
                console.error('Date manquante. Impossible d\'enregistrer.');
                return;
            }
            if (isNaN(count) || count < 0) {
                console.error('Nombre de cigarettes invalide. Impossible d\'enregistrer.');
                return;
            }

            const existingRecordIndex = records.findIndex(r => r.date === date);

            if (count === 0) {
                if (existingRecordIndex !== -1) {
                    records.splice(existingRecordIndex, 1);
                }
            } else {
                if (existingRecordIndex !== -1) {
                    records[existingRecordIndex] = { ...records[existingRecordIndex], count: count };
                } else {
                    records.push({ id: generateUniqueId(), date: date, count: count });
                }
            }

            localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            loadRecords(); // Recharge les enregistrements pour mettre √† jour la liste, les stats et les graphiques
        }

        // √âcouteurs d'√©v√©nements pour l'enregistrement automatique
        incrementButton.addEventListener('click', () => {
            cigaretteCountInput.value = parseInt(cigaretteCountInput.value, 10) + 1;
            saveOrUpdateConsumption();
        });

        decrementButton.addEventListener('click', () => {
            const currentCount = parseInt(cigaretteCountInput.value, 10);
            if (currentCount > 0) {
                cigaretteCountInput.value = currentCount - 1;
            }
            saveOrUpdateConsumption(); // Appeler m√™me si le compte est d√©j√† 0 pour g√©rer la suppression
        });

        cigaretteCountInput.addEventListener('input', () => {
             // S'assurer que la valeur est un nombre valide avant de sauvegarder
            const value = cigaretteCountInput.value;
            if (value === '' || value === null) {
                return; 
            }
            const count = parseInt(value, 10);
            if (!isNaN(count) && count >= 0) {
                saveOrUpdateConsumption();
            }
        });

        recordDateInput.addEventListener('change', () => {
            const selectedDate = recordDateInput.value;
            const existingRecord = records.find(r => r.date === selectedDate);
            cigaretteCountInput.value = existingRecord ? existingRecord.count : 0;
            // Pas d'appel √† saveOrUpdateConsumption ici. La valeur est juste charg√©e.
            // L'utilisateur devra interagir avec le champ count ou les boutons pour d√©clencher la sauvegarde.
        });


        function updateStatistics() {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Normalize to start of today

            let totalToday = 0;
            let totalThisWeek = 0;
            let totalThisMonth = 0;
            let grandTotal = 0; // Nouveau : total g√©n√©ral
            let last7DaysCounts = [];

            records.forEach(record => {
                const recordDate = new Date(record.date);
                recordDate.setHours(0, 0, 0, 0);

                // Total g√©n√©ral
                grandTotal += record.count;

                // Total Today
                if (recordDate.toDateString() === now.toDateString()) {
                    totalToday += record.count;
                }

                // Total This Week (Sunday to Saturday for simplicity, adjust as needed)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Go to Sunday
                startOfWeek.setHours(0, 0, 0, 0);

                if (recordDate >= startOfWeek && recordDate <= now) {
                    totalThisWeek += record.count;
                }

                // Total This Month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                if (recordDate >= startOfMonth && recordDate <= now) {
                    totalThisMonth += record.count;
                }

                // Last 7 Days Average
                const sevenDaysAgo = new Date(now);
                sevenDaysAgo.setDate(now.getDate() - 6); // Includes today
                sevenDaysAgo.setHours(0, 0, 0, 0);

                if (recordDate >= sevenDaysAgo && recordDate <= now) {
                    last7DaysCounts.push({ date: recordDate.toDateString(), count: record.count });
                }
            });

            // Calculate average for last 7 days
            const dailyTotals = {};
            last7DaysCounts.forEach(item => {
                dailyTotals[item.date] = (dailyTotals[item.date] || 0) + item.count;
            });

            let sumLast7Days = 0;
            let daysWithRecords = 0;
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateString = date.toDateString();
                if (dailyTotals[dateString] !== undefined) {
                    sumLast7Days += dailyTotals[dateString];
                    daysWithRecords++;
                }
            }
            const avgDailyLast7Days = daysWithRecords > 0 ? (sumLast7Days / daysWithRecords).toFixed(1) : 0;


            avgDailyLast7DaysElement.textContent = avgDailyLast7Days;
            totalTodayElement.textContent = totalToday;
            totalThisWeekElement.textContent = totalThisWeek;
            totalThisMonthElement.textContent = totalThisMonth;
            totalCigarettesSmokedElement.textContent = grandTotal; // Mettre √† jour le total g√©n√©ral
        }

        // NEW: Prepare chart data, but don't render charts yet
        function prepareChartData() {
            const dailyData = {};
            const weeklyData = {};
            const monthlyData = {};

            records.forEach(record => {
                const date = new Date(record.date);
                date.setHours(0, 0, 0, 0);

                const dayKey = date.toISOString().split('T')[0];
                dailyData[dayKey] = (dailyData[dayKey] || 0) + record.count;

                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay());
                const weekKey = startOfWeek.toISOString().split('T')[0];
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + record.count;

                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + record.count;
            });

            const limitDays = 30;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dailyChartLabels = [];
            const dailyChartData = [];

            for (let i = limitDays - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateKey = d.toISOString().split('T')[0];
                const displayDate = formatDate(dateKey).replace(` ${d.getFullYear()}`, '');
                
                dailyChartLabels.push(displayDate);
                dailyChartData.push(dailyData[dateKey] || 0);
            }

            const sortedWeeklyLabels = Object.keys(weeklyData).sort();
            const readableWeeklyLabels = sortedWeeklyLabels.map(d => {
                const startDate = new Date(d);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                return `${formatDate(startDate.toISOString().split('T')[0]).slice(0, -5)} - ${formatDate(endDate.toISOString().split('T')[0]).slice(0, -5)}`;
            });
            const sortedWeeklyCounts = sortedWeeklyLabels.map(label => weeklyData[label]);

            const sortedMonthlyLabels = Object.keys(monthlyData).sort();
            const readableMonthlyLabels = sortedMonthlyLabels.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
            });
            const sortedMonthlyCounts = sortedMonthlyLabels.map(label => monthlyData[label]);

            // Store prepared data globally
            chartData.dailyLabels = dailyChartLabels;
            chartData.dailyCounts = dailyChartData;
            chartData.weeklyLabels = readableWeeklyLabels;
            chartData.weeklyCounts = sortedWeeklyCounts;
            chartData.monthlyLabels = readableMonthlyLabels;
            chartData.monthlyCounts = sortedMonthlyCounts;
        }

        // NEW: Individual chart rendering functions, called only when view is active
        function renderDailyChart() {
            if (dailyChartInstance) dailyChartInstance.destroy(); // Destroy previous instance
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: chartData.dailyLabels,
                    datasets: [{
                        label: 'Cigarettes par jour',
                        data: chartData.dailyCounts,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: -1, 
                            ticks: { color: '#d1d5db' }, 
                            grid: { color: '#4B5563' } 
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false } /* Removed Chart.js title as HTML title is used */
                    }
                }
            });
        }

        function renderWeeklyChart() {
            if (weeklyChartInstance) weeklyChartInstance.destroy(); // Destroy previous instance
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChartInstance = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: chartData.weeklyLabels,
                    datasets: [{
                        label: 'Cigarettes par semaine',
                        data: chartData.weeklyCounts,
                        backgroundColor: 'rgba(251, 191, 36, 0.7)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false } /* Removed Chart.js title as HTML title is used */
                    }
                }
            });
        }

        function renderMonthlyChart() {
            if (monthlyChartInstance) monthlyChartInstance.destroy(); // Destroy previous instance
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: chartData.monthlyLabels,
                    datasets: [{
                        label: 'Cigarettes par mois',
                        data: chartData.monthlyCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: -1, 
                            ticks: { color: '#d1d5db' }, 
                            grid: { color: '#4B5563' } 
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false } /* Removed Chart.js title as HTML title is used */
                    }
                }
            });
        }


        // Navigation logic
        function showView(viewId) {
            viewSections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.target === viewId) {
                    button.classList.add('active');
                }
            });

            // Render charts only when the trends view is active
            if (viewId === 'trendsView') {
                renderDailyChart();
                renderWeeklyChart();
                renderMonthlyChart();
            } else {
                // Destroy charts when leaving the trends view to free up memory
                if (dailyChartInstance) dailyChartInstance.destroy();
                if (weeklyChartInstance) weeklyChartInstance.destroy();
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                dailyChartInstance = null;
                weeklyChartInstance = null;
                monthlyChartInstance = null;
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.target);
            });
        });

        // Set current date on load
        recordDateInput.value = new Date().toISOString().split('T')[0];

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadRecords();
            // Show consumption view by default on load
            showView('consumptionView'); 
        });

    </script>
</body>
</html>
