<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmokeTrack üö≠</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.png" />
    <meta name="theme-color" content="#111827" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #000000; /* Fond noir comme demand√© */
            color: #f9fafb;
            line-height: 1.6;
        }
        h1, h2, h3 {
            text-align: center;
            color: #4CAF50; /* Vert pour la sant√© */
            margin-bottom: 1rem;
        }
        #mainTitle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            color: #4CAF50;
            cursor: pointer;
            font-size: 2em;
            margin-bottom: 1rem;
        }
        #mainTitle .logo {
            font-size: 1.2em;
        }

        /* Styles for navigation buttons */
        .nav-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px; /* Taille par d√©faut */
            height: 80px; /* Taille par d√©faut */
            border-radius: 50%;
            background: #2563eb; /* Blue for navigation */
            color: #ffffff;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.8em; /* Taille de police par d√©faut */
            text-align: center;
            padding: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.1s ease;
            border: none; /* Ensure no default button border */
            cursor: pointer;
        }

        .nav-button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .nav-button:active, .nav-button.active {
            background: #1d4ed8; /* Darker blue for active state */
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3); /* Inner shadow for pressed effect */
        }

        .nav-button .icon {
            font-size: 1.8em; /* Taille d'ic√¥ne par d√©faut */
            margin-bottom: 0.2em;
        }

        /* View sections visibility */
        .view-section {
            display: none; /* Hidden by default */
        }

        .view-section.active {
            display: block; /* Shown when active */
        }

        .container {
            max-width: 600px;
            margin: 1rem auto;
            background: #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        label {
            display: block;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #E0E7FF;
        }
        input[type="date"],
        input[type="number"],
        button,
        select {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.2rem;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            box-sizing: border-box;
            background: #4B5563;
            color: #f9fafb;
            font-size: 1rem;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        button[type="submit"], button.btn-action { /* Adjusted to target specific buttons */
            margin-top: 1.5rem;
            background: #4CAF50; /* Vert */
            color: #ffffff;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-size: 1.1rem;
            border: none;
        }
        button[type="submit"]:hover, button.btn-action:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        button[type="submit"]:active, button.btn.btn-action:active {
            transform: translateY(0);
        }

        .record-item {
            background: #111827;
            padding: 0.8rem 1.2rem;
            margin-top: 0.7rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-left: 5px solid #4CAF50;
        }
        .record-item:hover {
            background: #2563eb;
        }
        .record-item span {
            font-size: 1rem;
            color: #d1d5db;
        }
        .record-item .date {
            font-weight: bold;
            color: #FBBF24;
            flex-basis: 30%;
        }
        .record-item .count {
            font-weight: bold;
            color: #E0E7FF;
            flex-basis: 30%;
            text-align: right;
        }
        .record-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }
        .btn-action {
            background: #ef4444; /* Rouge pour supprimer */
            border: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            transition: background-color 0.3s ease;
            margin-top: 0; /* Override global margin-top for action buttons */
        }
        .btn-action:hover {
            background: #b91c1c;
        }
        .btn-edit {
            background: #3b82f6; /* Bleu pour modifier */
        }
        .btn-edit:hover {
            background: #1d4ed8;
        }

        .stats-section {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border-bottom: 4px solid #4CAF50;
        }
        .stat-card h3 {
            color: #FBBF24;
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.2em;
        }
        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: #E0E7FF;
            margin: 0;
        }

        .chart-container {
            margin-top: 2rem;
            max-height: 400px;
            overflow: hidden;
        }
        /* Style for the chart titles that are INSIDE the grey container, below the canvas */
        .chart-container h2 {
            text-align: center;
            color: #4CAF50;
            margin-top: 1rem; /* Adjusted margin to place below canvas */
            margin-bottom: 1rem;
        }
        /* Style for the new main titles OUTSIDE the grey containers */
        .chart-main-title {
            text-align: center;
            color: #FBBF24; /* Yellow for main chart titles */
            margin-top: 2rem; /* More space above */
            margin-bottom: 1rem; /* Space below */
            font-size: 1.8em; /* Larger font size */
        }

        /* Enforce canvas height and display */
        #dailyChart, #weeklyChart, #monthlyChart {
            max-width: 100%;
            height: 300px; /* Fixed height for charts */
            background: #111827;
            padding: 1rem; /* Padding applied to canvas, not its container */
            border-radius: 0.5rem;
            display: block; /* Ensures canvas respects its dimensions */
            margin: 0 auto; /* Center the canvas if it doesn't take full width */
        }

        /* Styles for increment/decrement buttons */
        .count-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .count-input-group input[type="number"] {
            flex-grow: 1; /* Allows the input to take available space */
            margin-top: 0; /* Remove default margin-top from global input rule */
            max-width: 100px;

        }
        .count-input-group .count-button {
            width: 40px; /* Fixed width for buttons */
            height: 40px; /* Fixed height for buttons */
            padding: 0; /* Remove padding */
            margin-top: 0; /* Remove default margin-top */
            font-size: 1.5rem;
            line-height: 1; /* Center content vertically */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            background: #4CAF50; /* Green */
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .count-input-group .count-button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        .count-input-group .count-button:active {
            transform: translateY(0);
        }
        .count-input-group .count-button.decrement {
            background: #ef4444; /* Red for decrement */
        }
        .count-input-group .count-button.decrement:hover {
            background: #b91c1c;
        }

        /* Calendar styles */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
            margin-top: 1rem;
        }
        .calendar-header {
            grid-column: span 7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: #FBBF24;
            font-size: 1.2em;
        }
        .calendar-header button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            width: auto; /* Override default button width */
        }
        .calendar-header button:hover {
            background: #1d4ed8;
        }
        .day-name, .day-cell {
            padding: 0.5rem 0;
            border-radius: 0.3rem;
            font-weight: bold;
        }
        .day-name {
            color: #d1d5db;
            background: #4B5563;
        }
        .day-cell {
            padding: 0.5rem 0;
            border-radius: 0.3rem;
            font-weight: bold;
            background: #111827;
            color: #f9fafb;
            min-height: 40px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Make day cells clickable for potential future features */
        }
        .day-cell.inactive {
            color: #6b7280;
            background: #374151;
        }
        .day-cell.smoked {
            background: #ef4444; /* Rouge */
            color: white;
        }
        .day-cell.no-smoke {
            background: #4CAF50; /* Vert */
            color: white;
        }
        .day-cell.today {
            border: 2px solid #FBBF24; /* Jaune pour aujourd'hui */
        }

        /* Toast / Snackbar for feedback */
        .snackbar {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0s 0.5s;
        }

        .snackbar.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s;
        }


        @media (max-width: 640px) {
            .container {
                padding: 1rem;
                margin: 0.5rem auto;
            }
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .record-item .date, .record-item .count {
                flex-basis: 100%;
                text-align: left;
            }
            .record-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
            }
            /* Stats cards smaller on mobile and 2 columns */
            .stats-section {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* 2 colonnes pour les statistiques */
                gap: 0.5rem; /* Espacement r√©duit */
            }
            .stat-card {
                padding: 0.5rem; /* R√©duire le padding encore */
            }
            .stat-card h3 {
                font-size: 0.9em; /* Texte encore plus petit pour les titres */
            }
            .stat-card p {
                font-size: 1.3em; /* Texte encore plus petit pour les valeurs */
            }

            .count-input-group {
                flex-wrap: nowrap; /* Emp√™che le retour √† la ligne des boutons */
            }
            .count-input-group input[type="number"] {
                width: auto;
            }
            .nav-buttons-container {
                align-items: center;
                gap: 0.5rem;
            }
            .nav-button {
                width: 65px;
                height: 65px;
                font-size: 0.65em; /* Texte des boutons encore plus petit */
            }
            .nav-button .icon {
                font-size: 1.5em; /* Ic√¥ne l√©g√®rement plus petite */
            }

            /* Calendar responsive */
            .calendar {
                gap: 3px;
            }
            .day-name, .day-cell {
                font-size: 0.8em;
                padding: 0.3rem 0;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Service Worker Registration (for PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker enregistr√©:', reg.scope))
                    .catch(err => console.error('Erreur SW:', err));
            });
        }
    </script>
</head>
<body>
    <h1 id="mainTitle">SmokeTrack <span class="logo">üö≠</span></h1>

    <div class="nav-buttons-container">
        <button class="nav-button active" data-target="consumptionView">
            <span class="icon">üö¨</span>
            Consommation
        </button>
        <button class="nav-button" data-target="historyView">
            <span class="icon">üìú</span>
            Historique
        </button>
        <button class="nav-button" data-target="calendarView">
            <span class="icon">üìÖ</span>
            Calendrier
        </button>
        <button class="nav-button" data-target="trendsView">
            <span class="icon">üìà</span>
            Tendances
        </button>
        <button class="nav-button" data-target="settingsView">
            <span class="icon">‚öôÔ∏è</span>
            Param√®tres
        </button>
    </div>

    <div id="consumptionView" class="view-section active">
        <div class="container">
            <h2>Add your consumption</h2>
            <form id="cigaretteForm">
                <label for="recordDate">Date</label>
                <input type="date" id="recordDate" required />

                <label for="cigaretteCount">Nombre de cigarettes</label>
                <div class="count-input-group">
                    <button type="button" id="decrementCount" class="count-button decrement">-</button>
                    <input type="number" id="cigaretteCount" min="0" value="0" required />
                    <button type="button" id="incrementCount" class="count-button">+</button>
                </div>
            </form>
        </div>

        <div class="container stats-section">
            <div class="stat-card">
                <h3>Moyenne quotidienne (7j)</h3>
                <p id="avgDailyLast7Days">0</p>
            </div>
            <div class="stat-card">
                <h3>Total aujourd'hui</h3>
                <p id="totalToday">0</p>
            </div>
            <div class="stat-card">
                <h3>Objectif quotidien</h3>
                <p id="dailyGoalStatus">0</p>
            </div>
            <div class="stat-card">
                <h3>Jours sans fumer (Total)</h3>
                <p id="smokeFreeDaysCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Plus longue s√©rie sans fumer</h3>
                <p id="longestStreak">0 jours</p>
            </div>
            <div class="stat-card">
                <h3>Total cette semaine</h3>
                <p id="totalThisWeek">0</p>
            </div>
            <div class="stat-card">
                <h3>Total ce mois</h3>
                <p id="totalThisMonth">0</p>
            </div>
            <div class="stat-card">
                <h3>Total g√©n√©ral</h3>
                <p id="totalCigarettesSmoked">0</p>
            </div>
        </div>
    </div>

    <div id="historyView" class="view-section">
        <div class="container">
            <h2>Historique des consommations</h2>
            <div id="recordList">
                </div>
        </div>
    </div>

    <div id="calendarView" class="view-section">
        <div class="container">
            <h2>Calendrier de consommation</h2>
            <div id="calendarContainer">
                </div>
        </div>
    </div>

    <div id="trendsView" class="view-section">
        <h2 class="chart-main-title">Tendances de consommation journali√®re</h2>
        <div class="container chart-container">
            <canvas id="dailyChart"></canvas>
            <h2>Tendances journali√®res (30 derniers jours)</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation hebdomadaire</h2>
        <div class="container chart-container">
            <canvas id="weeklyChart"></canvas>
            <h2>Tendances hebdomadaires</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation mensuelle</h2>
        <div class="container chart-container">
            <canvas id="monthlyChart"></canvas>
            <h2>Tendances mensuelles</h2>
        </div>
    </div>

    <div id="settingsView" class="view-section">
        <div class="container">
            <h2>Param√®tres de l'application</h2>

            <h3>Objectif de r√©duction</h3>
            <label for="dailyGoalInput">Mon objectif quotidien de cigarettes</label>
            <div class="count-input-group">
                <button type="button" id="decrementGoal" class="count-button decrement">-</button>
                <input type="number" id="dailyGoalInput" min="0" value="0" />
                <button type="button" id="incrementGoal" class="count-button">+</button>
            </div>

            <h3 style="margin-top: 2rem;">Calcul des √©conomies</h3>
            <label for="packPrice">Prix moyen d'un paquet (‚Ç¨)</label>
            <input type="number" id="packPrice" min="0" step="0.01" value="10.00" />

            <label for="cigsPerPack">Nombre de cigarettes par paquet</label>
            <input type="number" id="cigsPerPack" min="1" value="20" />

            <label for="baselineCigarettesPerDay">Ma consommation moyenne avant de commencer (cigarettes/jour)</label>
            <input type="number" id="baselineCigarettesPerDay" min="0" value="20" />

            <h3 style="margin-top: 2rem;">Argent √©conomis√©</h3>
            <div class="stats-section">
                <div class="stat-card">
                    <h3>Aujourd'hui</h3>
                    <p id="savedToday">0.00 ‚Ç¨</p>
                </div>
                <div class="stat-card">
                    <h3>Cette semaine</h3>
                    <p id="savedThisWeek">0.00 ‚Ç¨</p>
                </div>
                <div class="stat-card">
                    <h3>Total depuis le d√©but</h3>
                    <p id="savedTotal">0.00 ‚Ç¨</p>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">Gestion des donn√©es</h3>
            <button class="btn-action" id="exportData" style="background: #3b82f6;">Exporter les donn√©es</button>
            <input type="file" id="importData" accept=".json" style="display: none; margin-top: 1rem;" />
            <button class="btn-action" id="importDataButton" style="background: #22c55e;">Importer des donn√©es</button>
            <button class="btn-action" id="clearData" style="background: #ef4444; margin-top: 1rem;">Effacer toutes les donn√©es</button>
        </div>
    </div>

    <div id="snackbar" class="snackbar"></div>

    <script>
        const cigaretteForm = document.getElementById('cigaretteForm');
        const recordDateInput = document.getElementById('recordDate');
        const cigaretteCountInput = document.getElementById('cigaretteCount');
        const recordList = document.getElementById('recordList');
        const mainTitle = document.getElementById('mainTitle');
        const incrementButton = document.getElementById('incrementCount');
        const decrementButton = document.getElementById('decrementCount');

        // Stats elements
        const avgDailyLast7DaysElement = document.getElementById('avgDailyLast7Days');
        const totalTodayElement = document.getElementById('totalToday');
        const totalThisWeekElement = document.getElementById('totalThisWeek');
        const totalThisMonthElement = document.getElementById('totalThisMonth');
        const totalCigarettesSmokedElement = document.getElementById('totalCigarettesSmoked');
        const dailyGoalStatusElement = document.getElementById('dailyGoalStatus');
        const smokeFreeDaysCountElement = document.getElementById('smokeFreeDaysCount');
        const longestStreakElement = document.getElementById('longestStreak');

        // Settings elements
        const dailyGoalInput = document.getElementById('dailyGoalInput');
        const incrementGoalButton = document.getElementById('incrementGoal');
        const decrementGoalButton = document.getElementById('decrementGoal');
        const packPriceInput = document.getElementById('packPrice');
        const cigsPerPackInput = document.getElementById('cigsPerPack');
        const baselineCigarettesPerDayInput = document.getElementById('baselineCigarettesPerDay');
        const savedTodayElement = document.getElementById('savedToday');
        const savedThisWeekElement = document.getElementById('savedThisWeek');
        const savedTotalElement = document.getElementById('savedTotal');

        // Data management buttons
        const exportDataButton = document.getElementById('exportData');
        const importDataInput = document.getElementById('importData');
        const importDataButton = document.getElementById('importDataButton');
        const clearDataButton = document.getElementById('clearData');

        // Navigation elements
        const navButtons = document.querySelectorAll('.nav-button');
        const viewSections = document.querySelectorAll('.view-section');
        const snackbar = document.getElementById('snackbar');

        // Calendar elements
        const calendarContainer = document.getElementById('calendarContainer');
        let currentCalendarDate = new Date(); // To keep track of the month displayed in the calendar

        let records = [];

        // Chart instances
        let dailyChartInstance = null;
        let weeklyChartInstance = null;
        let monthlyChartInstance = null;

        // Data holders for charts
        let chartData = {
            dailyLabels: [], dailyCounts: [],
            weeklyLabels: [], weeklyCounts: [],
            monthlyLabels: [], monthlyCounts: []
        };

        // Settings variables (loaded from localStorage)
        let dailyGoal = parseInt(localStorage.getItem('dailyCigaretteGoal')) || 0;
        let packPrice = parseFloat(localStorage.getItem('packPrice')) || 10.00;
        let cigsPerPack = parseInt(localStorage.getItem('cigsPerPack')) || 20;
        let baselineCigarettesPerDay = parseInt(localStorage.getItem('baselineCigarettesPerDay')) || 20;

        // --- Helper functions for date handling consistency ---
        // Parses a 'YYYY-MM-DD' string into a Date object at the start of that day in LOCAL timezone.
        function parseISODateStringToLocalDate(isoDateString) {
            const [year, month, day] = isoDateString.split('-').map(Number);
            return new Date(year, month - 1, day); // Month is 0-indexed
        }

        // Formats a Date object into a 'YYYY-MM-DD' string using its LOCAL year, month, and day.
        function formatLocalDateToISOString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        // --- End Helper functions ---

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function showSnackbar(message, duration = 3000) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, duration);
        }

        function loadRecords() {
            const storedRecords = JSON.parse(localStorage.getItem('smokeTrackRecords')) || [];
            records = [];
            let changed = false;

            // Ensure all records have an ID and filter out 0-count records
            storedRecords.forEach(record => {
                if (!record.id) {
                    record.id = generateUniqueId();
                    changed = true;
                }
                if (record.count > 0) { // Only keep records with count > 0
                    records.push(record);
                } else {
                    changed = true; // Mark as changed if a 0-count record was removed
                }
            });

            if (changed) {
                localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            }

            // Sort records by date descending for display
            records.sort((a, b) => parseISODateStringToLocalDate(b.date) - parseISODateStringToLocalDate(a.date));
            displayRecords();
            updateStatistics();
            prepareChartData(); // Prepare chart data after records are loaded/updated
            renderCalendar(currentCalendarDate); // Render calendar after records are loaded
            updateConsumptionViewForSelectedDate(); // Update consumption view with current date's record
        }

        function displayRecords() {
            recordList.innerHTML = '';
            if (records.length === 0) {
                recordList.innerHTML = '<p style="text-align: center; color: #d1d5db;">Aucune consommation enregistr√©e pour le moment.</p>';
                return;
            }

            records.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.dataset.id = record.id;

                div.innerHTML = `
                    <span class="date">${formatDate(record.date)}</span>
                    <span class="count">${record.count} cigarette(s)</span>
                    <div class="record-actions">
                        <button class="btn-action btn-edit" data-id="${record.id}" title="Modifier cet enregistrement">‚úèÔ∏è Modifier</button>
                        <button class="btn-action btn-delete" data-id="${record.id}" title="Supprimer cet enregistrement">üóëÔ∏è Supprimer</button>
                    </div>
                `;

                const btnDelete = div.querySelector('.btn-delete');
                const btnEdit = div.querySelector('.btn-edit');

                btnDelete.addEventListener('click', e => {
                    e.stopPropagation();
                    const recordIdToDelete = e.target.dataset.id;
                    const recordToDelete = records.find(r => r.id === recordIdToDelete);
                    if (confirm(`Supprimer l'enregistrement du ${formatDate(recordToDelete.date)} (${recordToDelete.count} cigarettes) ?`)) {
                        records = records.filter(r => r.id !== recordIdToDelete);
                        localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
                        loadRecords(); // Reload to update list, stats, and charts
                        showSnackbar('Enregistrement supprim√©.');
                    }
                });

                btnEdit.addEventListener('click', e => {
                    e.stopPropagation();
                    const recordIdToEdit = e.target.dataset.id;
                    const recordToEdit = records.find(r => r.id === recordIdToEdit);

                    if (recordToEdit) {
                        recordDateInput.value = recordToEdit.date;
                        cigaretteCountInput.value = recordToEdit.count;
                        showView('consumptionView'); // Switch to consumption view for editing
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of the view
                        showSnackbar('Enregistrement charg√© pour modification.');
                    }
                });

                recordList.appendChild(div);
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const d = parseISODateStringToLocalDate(dateStr); // Use helper to ensure local date interpretation
            return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function saveOrUpdateConsumption() {
            const date = recordDateInput.value;
            const count = parseInt(cigaretteCountInput.value, 10);

            if (!date) {
                console.error('Date manquante. Impossible d\'enregistrer.');
                showSnackbar('Date manquante.', 2000);
                return;
            }
            if (isNaN(count) || count < 0) {
                console.error('Nombre de cigarettes invalide. Impossible d\'enregistrer.');
                showSnackbar('Nombre de cigarettes invalide.', 2000);
                return;
            }

            const existingRecordIndex = records.findIndex(r => r.date === date);
            let message = '';

            if (count === 0) {
                if (existingRecordIndex !== -1) {
                    records.splice(existingRecordIndex, 1);
                    message = 'Enregistrement supprim√©.';
                } else {
                    // No record for this date and count is 0, nothing to do
                    return;
                }
            } else {
                if (existingRecordIndex !== -1) {
                    records[existingRecordIndex] = { ...records[existingRecordIndex], count: count };
                    message = 'Consommation mise √† jour.';
                } else {
                    records.push({ id: generateUniqueId(), date: date, count: count });
                    message = 'Consommation ajout√©e.';
                }
            }

            localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            loadRecords(); // Reload to update list, stats, and charts
            showSnackbar(message);
        }

        // √âcouteurs d'√©v√©nements pour l'enregistrement automatique
        incrementButton.addEventListener('click', () => {
            cigaretteCountInput.value = parseInt(cigaretteCountInput.value, 10) + 1;
            saveOrUpdateConsumption();
        });

        decrementButton.addEventListener('click', () => {
            const currentCount = parseInt(cigaretteCountInput.value, 10);
            if (currentCount > 0) {
                cigaretteCountInput.value = currentCount - 1;
            } else if (currentCount === 0) { // If it's already 0, and they decrement, delete record if exists
                 // No change needed, but trigger save to remove the 0-count record if exists
            }
            saveOrUpdateConsumption(); // Appeler m√™me si le compte est d√©j√† 0 pour g√©rer la suppression
        });


        cigaretteCountInput.addEventListener('input', () => {
             const value = cigaretteCountInput.value;
            // Allow empty string temporarily for user input, but don't save.
            if (value === '' || value === null || isNaN(parseInt(value, 10))) {
                return;
            }
            const count = parseInt(value, 10);
            if (!isNaN(count) && count >= 0) {
                saveOrUpdateConsumption();
            }
        });

        function updateConsumptionViewForSelectedDate() {
            const selectedDate = recordDateInput.value;
            const existingRecord = records.find(r => r.date === selectedDate);
            cigaretteCountInput.value = existingRecord ? existingRecord.count : 0;
        }

        recordDateInput.addEventListener('change', updateConsumptionViewForSelectedDate);

        // Settings functions
        function loadSettings() {
            dailyGoal = parseInt(localStorage.getItem('dailyCigaretteGoal')) || 0;
            packPrice = parseFloat(localStorage.getItem('packPrice')) || 10.00;
            cigsPerPack = parseInt(localStorage.getItem('cigsPerPack')) || 20;
            baselineCigarettesPerDay = parseInt(localStorage.getItem('baselineCigarettesPerDay')) || 20;

            dailyGoalInput.value = dailyGoal;
            packPriceInput.value = packPrice.toFixed(2);
            cigsPerPackInput.value = cigsPerPack;
            baselineCigarettesPerDayInput.value = baselineCigarettesPerDay;
        }

        function saveSettings() {
            dailyGoal = parseInt(dailyGoalInput.value, 10);
            packPrice = parseFloat(packPriceInput.value);
            cigsPerPack = parseInt(cigsPerPackInput.value, 10);
            baselineCigarettesPerDay = parseInt(baselineCigarettesPerDayInput.value, 10);

            localStorage.setItem('dailyCigaretteGoal', dailyGoal);
            localStorage.setItem('packPrice', packPrice);
            localStorage.setItem('cigsPerPack', cigsPerPack);
            localStorage.setItem('baselineCigarettesPerDay', baselineCigarettesPerDay);

            updateStatistics();
            showSnackbar('Param√®tres sauvegard√©s.');
        }

        incrementGoalButton.addEventListener('click', () => {
            dailyGoalInput.value = parseInt(dailyGoalInput.value, 10) + 1;
            saveSettings();
        });

        decrementGoalButton.addEventListener('click', () => {
            const currentGoal = parseInt(dailyGoalInput.value, 10);
            if (currentGoal > 0) {
                dailyGoalInput.value = currentGoal - 1;
            }
            saveSettings();
        });

        packPriceInput.addEventListener('input', () => { // Use input for live update while typing
            const value = packPriceInput.value;
            if (value === '' || isNaN(parseFloat(value))) return;
            saveSettings();
        });
        cigsPerPackInput.addEventListener('input', () => {
            const value = cigsPerPackInput.value;
            if (value === '' || isNaN(parseInt(value, 10))) return;
            saveSettings();
        });
        baselineCigarettesPerDayInput.addEventListener('input', () => {
            const value = baselineCigarettesPerDayInput.value;
            if (value === '' || isNaN(parseInt(value, 10))) return;
            saveSettings();
        });


        function updateStatistics() {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Normalize to start of today

            let totalToday = 0;
            let totalThisWeek = 0;
            let totalThisMonth = 0;
            let grandTotal = 0;
            let last7DaysCounts = [];
            let smokeFreeDays = 0;
            let currentStreak = 0;
            let longestStreak = 0;

            const sortedRecords = [...records].sort((a, b) => parseISODateStringToLocalDate(a.date) - parseISODateStringToLocalDate(b.date)); // Sort ascending for streak calc

            const costPerCigarette = (cigsPerPack > 0) ? (packPrice / cigsPerPack) : 0;
            let totalCigsNotSmokedEver = 0;

            // --- Calculations for streaks and total savings from baseline ---
            let previousDayHadRecord = false;
            let currentDateCheck = new Date(now); // Start checking from today backwards
            let firstRecordDate = sortedRecords.length > 0 ? parseISODateStringToLocalDate(sortedRecords[0].date) : null;

            // Loop back from today to calculate smoke-free days and longest streak
            // We go back up to 365 days or until before the first record, whichever comes first
            for (let i = 0; i < 366; i++) {
                const checkDate = new Date(now);
                checkDate.setDate(now.getDate() - i);
                checkDate.setHours(0, 0, 0, 0);
                const checkDateISO = formatLocalDateToISOString(checkDate); // Use helper for consistency
                const recordForDay = records.find(r => r.date === checkDateISO);

                if (!recordForDay || recordForDay.count === 0) {
                    if (checkDate <= now) { // Only count past/today as smoke-free
                        smokeFreeDays++;
                        currentStreak++;
                    }
                } else {
                    longestStreak = Math.max(longestStreak, currentStreak);
                    currentStreak = 0;
                }

                // Break loop if we've gone past the very first record date
                if (firstRecordDate && checkDate < firstRecordDate) {
                    break;
                }
            }
            longestStreak = Math.max(longestStreak, currentStreak); // Final check for streak ending today


            records.forEach(record => {
                const recordDate = parseISODateStringToLocalDate(record.date); // Use helper
                recordDate.setHours(0, 0, 0, 0);

                // Total g√©n√©ral
                grandTotal += record.count;

                // Total Today
                if (recordDate.toDateString() === now.toDateString()) {
                    totalToday += record.count;
                }

                // Total This Week (Sunday to Saturday for simplicity, adjust as needed)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Go to Sunday
                startOfWeek.setHours(0, 0, 0, 0);

                if (recordDate >= startOfWeek && recordDate <= now) {
                    totalThisWeek += record.count;
                }

                // Total This Month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                if (recordDate >= startOfMonth && recordDate <= now) {
                    totalThisMonth += record.count;
                }

                // Last 7 Days Average
                const sevenDaysAgo = new Date(now);
                sevenDaysAgo.setDate(now.getDate() - 6); // Includes today
                sevenDaysAgo.setHours(0, 0, 0, 0);

                if (recordDate >= sevenDaysAgo && recordDate <= now) {
                    last7DaysCounts.push({ date: recordDate.toDateString(), count: record.count });
                }

                // Total cigarettes NOT smoked compared to baseline
                totalCigsNotSmokedEver += Math.max(0, baselineCigarettesPerDay - record.count);
            });

            // Calculate average for last 7 days
            const dailyTotals = {};
            last7DaysCounts.forEach(item => {
                dailyTotals[item.date] = (dailyTotals[item.date] || 0) + item.count;
            });

            let sumLast7Days = 0;
            let daysConsideredFor7DayAvg = 0; // Number of days within the last 7 with a record (or 0 if no record)
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateString = date.toDateString();
                // If there's a record for the day, or if the day is past the first recorded day, count it
                if (dailyTotals[dateString] !== undefined || (firstRecordDate && date >= firstRecordDate)) {
                    sumLast7Days += (dailyTotals[dateString] || 0);
                    daysConsideredFor7DayAvg++;
                }
            }
            const avgDailyLast7Days = daysConsideredFor7DayAvg > 0 ? (sumLast7Days / daysConsideredFor7DayAvg).toFixed(1) : 0;


            // Calculate savings amounts
            const savedTodayCigs = Math.max(0, baselineCigarettesPerDay - totalToday);
            const savedTodayAmount = (savedTodayCigs * costPerCigarette).toFixed(2);

            let savedThisWeekCigs = 0;
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
            startOfWeek.setHours(0,0,0,0);

            for (let d = new Date(startOfWeek); d <= now; d.setDate(d.getDate() + 1)) {
                const dayISO = formatLocalDateToISOString(d); // Use helper for consistency
                const recordForDay = records.find(r => r.date === dayISO);
                savedThisWeekCigs += Math.max(0, baselineCigarettesPerDay - (recordForDay ? recordForDay.count : 0));
            }
            const savedThisWeekAmount = (savedThisWeekCigs * costPerCigarette).toFixed(2);


            const savedTotalAmount = (totalCigsNotSmokedEver * costPerCigarette).toFixed(2);


            avgDailyLast7DaysElement.textContent = avgDailyLast7Days;
            totalTodayElement.textContent = totalToday;
            totalThisWeekElement.textContent = totalThisWeek;
            totalThisMonthElement.textContent = totalThisMonth;
            totalCigarettesSmokedElement.textContent = grandTotal;

            // Update Goal Status
            if (dailyGoal > 0) {
                dailyGoalStatusElement.textContent = `${totalToday} / ${dailyGoal} ${totalToday <= dailyGoal ? '‚úîÔ∏è' : '‚ùå'}`;
                dailyGoalStatusElement.style.color = totalToday <= dailyGoal ? '#4CAF50' : '#ef4444';
            } else {
                dailyGoalStatusElement.textContent = `Non d√©fini`;
                dailyGoalStatusElement.style.color = '#d1d5db';
            }

            // Update smoke-free stats
            smokeFreeDaysCountElement.textContent = smokeFreeDays;
            longestStreakElement.textContent = `${longestStreak} jours`;

            // Update savings display
            savedTodayElement.textContent = `${savedTodayAmount} ‚Ç¨`;
            savedThisWeekElement.textContent = `${savedThisWeekAmount} ‚Ç¨`;
            savedTotalElement.textContent = `${savedTotalAmount} ‚Ç¨`;
        }

        function prepareChartData() {
            const dailyData = {};
            const weeklyData = {};
            const monthlyData = {};

            records.forEach(record => {
                const date = parseISODateStringToLocalDate(record.date); // Use helper
                date.setHours(0, 0, 0, 0);

                const dayKey = formatLocalDateToISOString(date); // Use helper
                dailyData[dayKey] = (dailyData[dayKey] || 0) + record.count;

                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay());
                const weekKey = formatLocalDateToISOString(startOfWeek); // Use helper
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + record.count;

                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + record.count;
            });

            const limitDays = 30;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dailyChartLabels = [];
            const dailyChartData = [];

            for (let i = limitDays - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateKey = formatLocalDateToISOString(d); // Use helper
                const displayDate = formatDate(dateKey).replace(` ${d.getFullYear()}`, '');

                dailyChartLabels.push(displayDate);
                dailyChartData.push(dailyData[dateKey] || 0);
            }

            const sortedWeeklyLabels = Object.keys(weeklyData).sort();
            const readableWeeklyLabels = sortedWeeklyLabels.map(d => {
                const startDate = parseISODateStringToLocalDate(d); // Use helper
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                return `${formatDate(formatLocalDateToISOString(startDate)).slice(0, -5)} - ${formatDate(formatLocalDateToISOString(endDate)).slice(0, -5)}`; // Use helper for consistency
            });
            const sortedWeeklyCounts = sortedWeeklyLabels.map(label => weeklyData[label]);

            const sortedMonthlyLabels = Object.keys(monthlyData).sort();
            const readableMonthlyLabels = sortedMonthlyLabels.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
            });
            const sortedMonthlyCounts = sortedMonthlyLabels.map(label => monthlyData[label]);

            chartData.dailyLabels = dailyChartLabels;
            chartData.dailyCounts = dailyChartData;
            chartData.weeklyLabels = readableWeeklyLabels;
            chartData.weeklyCounts = sortedWeeklyCounts;
            chartData.monthlyLabels = readableMonthlyLabels;
            chartData.monthlyCounts = sortedMonthlyCounts;
        }

        function renderDailyChart() {
            if (dailyChartInstance) dailyChartInstance.destroy();
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: chartData.dailyLabels,
                    datasets: [{
                        label: 'Cigarettes par jour',
                        data: chartData.dailyCounts,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderWeeklyChart() {
            if (weeklyChartInstance) weeklyChartInstance.destroy();
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChartInstance = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: chartData.weeklyLabels,
                    datasets: [{
                        label: 'Cigarettes par semaine',
                        data: chartData.weeklyCounts,
                        backgroundColor: 'rgba(251, 191, 36, 0.7)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderMonthlyChart() {
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: chartData.monthlyLabels,
                    datasets: [{
                        label: 'Cigarettes par mois',
                        data: chartData.monthlyCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderCalendar(date) {
            calendarContainer.innerHTML = ''; // Clear previous calendar
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // Adjust to start on Monday (0=Mon, 6=Sun)

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            const dayNames = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];

            const headerDiv = document.createElement('div');
            headerDiv.className = 'calendar-header';
            headerDiv.innerHTML = `
                <button id="prevMonth">‚Üê</button>
                <span>${monthNames[month]} ${year}</span>
                <button id="nextMonth">‚Üí</button>
            `;
            calendarContainer.appendChild(headerDiv);

            document.getElementById('prevMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate);
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate);
            });

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'calendar';
            calendarContainer.appendChild(calendarGrid);

            // Add day names
            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = 'day-name';
                dayNameDiv.textContent = day;
                calendarGrid.appendChild(dayNameDiv);
            });

            // Add empty cells for days before the 1st of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell inactive';
                calendarGrid.appendChild(emptyCell);
            }

            // Add days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.textContent = i;

                const currentDay = new Date(year, month, i);
                currentDay.setHours(0, 0, 0, 0);
                const currentDayISO = formatLocalDateToISOString(currentDay); // Use helper for consistency

                const recordForDay = records.find(r => r.date === currentDayISO);

                if (recordForDay && recordForDay.count > 0) {
                    dayCell.classList.add('smoked');
                } else if (currentDay <= today) { // Only mark as 'no-smoke' if it's today or in the past
                    dayCell.classList.add('no-smoke');
                }

                if (currentDay.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }

                // Add event listener to day cells to select that date in consumption view
                dayCell.addEventListener('click', () => {
                    recordDateInput.value = currentDayISO;
                    updateConsumptionViewForSelectedDate();
                    showView('consumptionView');
                });

                calendarGrid.appendChild(dayCell);
            }
        }


        // Navigation logic
        function showView(viewId) {
            viewSections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.target === viewId) {
                    button.classList.add('active');
                }
            });

            // Render charts or calendar only when their respective views are active
            if (viewId === 'trendsView') {
                renderDailyChart();
                renderWeeklyChart();
                renderMonthlyChart();
            } else {
                // Destroy charts when leaving the trends view to free up memory
                if (dailyChartInstance) dailyChartInstance.destroy();
                if (weeklyChartInstance) weeklyChartInstance.destroy();
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                dailyChartInstance = null;
                weeklyChartInstance = null;
                monthlyChartInstance = null;
            }

            if (viewId === 'calendarView') {
                renderCalendar(currentCalendarDate);
            }

            if (viewId === 'settingsView') {
                loadSettings(); // Ensure settings fields are populated
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.target);
            });
        });

        // Data Management functions
        exportDataButton.addEventListener('click', () => {
            const data = {
                records: records,
                settings: {
                    dailyCigaretteGoal: dailyGoal,
                    packPrice: packPrice,
                    cigsPerPack: cigsPerPack,
                    baselineCigarettesPerDay: baselineCigarettesPerDay
                }
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'smokeTrack_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSnackbar('Donn√©es export√©es avec succ√®s.');
        });

        importDataButton.addEventListener('click', () => {
            importDataInput.click(); // Trigger the hidden file input
        });

        importDataInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.records && Array.isArray(importedData.records)) {
                        // Merge or replace records (let's replace for simplicity)
                        // If merging, you'd need logic to handle duplicates by date/ID
                        records = importedData.records;
                        localStorage.setItem('smokeTrackRecords', JSON.stringify(records));

                        if (importedData.settings) {
                            localStorage.setItem('dailyCigaretteGoal', importedData.settings.dailyCigaretteGoal || 0);
                            localStorage.setItem('packPrice', importedData.settings.packPrice || 10.00);
                            localStorage.setItem('cigsPerPack', importedData.settings.cigsPerPack || 20);
                            localStorage.setItem('baselineCigarettesPerDay', importedData.settings.baselineCigarettesPerDay || 20);
                            loadSettings(); // Reload settings display
                        }

                        loadRecords(); // Reload everything based on new data
                        showSnackbar('Donn√©es import√©es avec succ√®s.');
                    } else {
                        throw new Error('Format de donn√©es invalide.');
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'importation des donn√©es:', error);
                    showSnackbar('Erreur lors de l\'importation des donn√©es: ' + error.message, 5000);
                } finally {
                    importDataInput.value = ''; // Clear the input so same file can be selected again
                }
            };
            reader.readAsText(file);
        });

        clearDataButton.addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir EFFACER TOUTES VOS DONN√âES ? Cette action est irr√©versible.')) {
                localStorage.removeItem('smokeTrackRecords');
                localStorage.removeItem('dailyCigaretteGoal');
                localStorage.removeItem('packPrice');
                localStorage.removeItem('cigsPerPack');
                localStorage.removeItem('baselineCigarettesPerDay');
                records = []; // Clear current records array
                loadRecords(); // Reinitialize everything
                loadSettings(); // Reinitialize settings
                showSnackbar('Toutes les donn√©es ont √©t√© effac√©es.');
            }
        });


        // Set current date on load
        recordDateInput.value = formatLocalDateToISOString(new Date()); // Use helper for consistency

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings(); // Load settings first
            loadRecords(); // Then load records and update stats/charts/calendar
            // Show consumption view by default on load
            showView('consumptionView');
        });

    </script>
</body>
</html>