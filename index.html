<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmokeTrack 🚭</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.png" />
    <meta name="theme-color" content="#111827" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #000000; /* Fond noir */
            color: #f9fafb;
            line-height: 1.6;
        }
        h1, h2, h3 {
            text-align: center;
            color: #4CAF50; /* Vert pour la santé */
            margin-bottom: 1rem;
        }
        #mainTitle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            color: #4CAF50;
            cursor: pointer;
            font-size: 2em;
            margin-bottom: 1rem;
        }
        #mainTitle .logo {
            font-size: 1.2em;
        }

        /* Styles for navigation buttons */
        .nav-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #2563eb; /* Blue for navigation */
            color: #ffffff;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.8em;
            text-align: center;
            padding: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
        }

        .nav-button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .nav-button:active, .nav-button.active {
            background: #1d4ed8;
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .nav-button .icon {
            font-size: 1.8em;
            margin-bottom: 0.2em;
        }

        /* View sections visibility */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .container {
            max-width: 600px;
            margin: 1rem auto;
            background: #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        label {
            display: block;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #E0E7FF;
        }
        input[type="date"],
        input[type="number"],
        button,
        select {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.2rem;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            box-sizing: border-box;
            background: #4B5563;
            color: #f9fafb;
            font-size: 1rem;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        button[type="submit"], button.btn-action {
            margin-top: 1.5rem;
            background: #4CAF50; /* Vert */
            color: #ffffff;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-size: 1.1rem;
            border: none;
        }
        button[type="submit"]:hover, button.btn-action:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        button[type="submit"]:active, button.btn.btn-action:active {
            transform: translateY(0);
        }

        /* Big Red Button for NOW tab */
        #addTodayCigaretteBigButton {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: #ef4444; /* Rouge vif */
            color: white;
            font-size: 1.2rem; /* Initial text size */
            font-weight: bold;
            border: 5px solid #dc2626; /* Darker red border for "alarm" effect */
            cursor: pointer;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.7), 0 0 40px rgba(239, 68, 68, 0.4); /* Glow effect */
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            margin: 3rem auto; /* Center the button */
            text-align: center;
            position: relative; /* For inner count display */
        }

        #addTodayCigaretteBigButton:hover {
            background: #dc2626;
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.9), 0 0 50px rgba(239, 68, 68, 0.6);
        }

        #addTodayCigaretteBigButton:active {
            transform: scale(0.98);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            background: #b91c1c;
        }

        #bigCigaretteCountDisplay {
            font-size: 3.5rem; /* Larger font for count */
            font-weight: bold;
            color: #f9fafb;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Make sure clicks go through to the button */
        }
        #bigButtonText {
            font-size: 1.2rem;
            position: absolute;
            bottom: 25px; /* Position below count */
            width: 100%;
            left: 0;
        }


        .record-item {
            background: #111827;
            padding: 0.8rem 1.2rem;
            margin-top: 0.7rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-left: 5px solid #4CAF50;
        }
        .record-item:hover {
            background: #2563eb;
        }
        .record-item span {
            font-size: 1rem;
            color: #d1d5db;
        }
        .record-item .date {
            font-weight: bold;
            color: #FBBF24;
            flex-basis: 30%;
        }
        .record-item .count {
            font-weight: bold;
            color: #E0E7FF;
            flex-basis: 30%;
            text-align: right;
        }
        .record-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }
        .btn-action {
            background: #ef4444; /* Rouge pour supprimer */
            border: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            transition: background-color 0.3s ease;
            margin-top: 0;
        }
        .btn-action:hover {
            background: #b91c1c;
        }
        .btn-edit {
            background: #3b82f6; /* Bleu pour modifier */
        }
        .btn-edit:hover {
            background: #1d4ed8;
        }

        .stats-section {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border-bottom: 4px solid #4CAF50;
        }
        .stat-card h3 {
            color: #FBBF24;
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.2em;
        }
        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: #E0E7FF;
            margin: 0;
        }

        .chart-container {
            margin-top: 2rem;
            max-height: 400px;
            overflow: hidden;
        }
        .chart-container h2 {
            text-align: center;
            color: #4CAF50;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .chart-main-title {
            text-align: center;
            color: #FBBF24;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.8em;
        }

        #dailyChart, #weeklyChart, #monthlyChart {
            max-width: 100%;
            height: 300px;
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            display: block;
            margin: 0 auto;
        }

        .count-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .count-input-group input[type="number"] {
            flex-grow: 1;
            margin-top: 0;
            max-width: 100px; /* Constrain width for number input */
        }
        .count-input-group .count-button {
            width: 40px;
            height: 40px;
            padding: 0;
            margin-top: 0;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .count-input-group .count-button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        .count-input-group .count-button:active {
            transform: translateY(0);
        }
        .count-input-group .count-button.decrement {
            background: #ef4444;
        }
        .count-input-group .count-button.decrement:hover {
            background: #b91c1c;
        }

        /* Calendar styles */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
            margin-top: 1rem;
        }
        .calendar-header {
            grid-column: span 7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: #FBBF24;
            font-size: 1.2em;
        }
        .calendar-header button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1em;
            width: auto;
        }
        .calendar-header button:hover {
            background: #1d4ed8;
        }
        .day-name, .day-cell {
            padding: 0.5rem 0;
            border-radius: 0.3rem;
            font-weight: bold;
        }
        .day-name {
            color: #d1d5db;
            background: #4B5563;
        }
        .day-cell {
            padding: 0.5rem 0;
            border-radius: 0.3rem;
            font-weight: bold;
            background: #111827;
            color: #f9fafb;
            min-height: 40px;
            display: flex;
            flex-direction: column; /* Allow content to stack */
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .day-cell.inactive {
            color: #6b7280;
            background: #374151;
        }
        .day-cell.smoked {
            background: #ef4444; /* Rouge */
            color: white;
        }
        .day-cell.no-smoke {
            background: #4CAF50; /* Vert */
            color: white;
        }
        .day-cell.today {
            border: 2px solid #FBBF24; /* Jaune pour aujourd'hui */
        }
        .day-cell .badge-smiley {
            font-size: 0.7em; /* Smaller for icon */
            margin-top: 2px;
        }

        /* Toast / Snackbar for feedback */
        .snackbar {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0s 0.5s;
        }

        .snackbar.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s;
        }

        /* Badges Grid Styles */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .badge-card {
            background: #1e293b;
            padding: 0.8rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #4CAF50;
            display: flex; /* For progress text */
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px; /* Ensure consistent height */
        }
        .badge-card .badge-icon {
            font-size: 2em;
            margin-bottom: 0.2rem;
            flex-grow: 1; /* Allow icon to take space */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .badge-card .badge-name {
            font-weight: bold;
            color: #FBBF24;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .badge-card .badge-description {
            font-size: 0.75em;
            color: #cbd5e1;
            margin-top: 0.2rem;
        }
        .badge-card .badge-progress {
            font-size: 0.7em;
            color: #a0aec0; /* Grey for progress text */
            margin-top: 0.5rem;
            font-weight: bold;
        }


        @media (max-width: 640px) {
            body {
                padding: 0.5rem;
            }
            .container {
                padding: 1rem;
                margin: 0.5rem auto;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            h3 {
                font-size: 1.1em;
            }
            label {
                font-size: 0.9em;
            }
            input[type="date"],
            input[type="number"],
            button,
            select {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            button[type="submit"], button.btn-action {
                font-size: 1rem;
            }

            /* Big Red Button for NOW tab responsive */
            #addTodayCigaretteBigButton {
                width: 200px;
                height: 200px;
                font-size: 1rem;
                border-width: 3px;
                margin: 2rem auto;
            }
            #bigCigaretteCountDisplay {
                font-size: 2.8rem;
            }
            #bigButtonText {
                font-size: 1rem;
                bottom: 20px;
            }


            .nav-buttons-container {
                align-items: center;
                gap: 0.4rem;
                margin-bottom: 1.5rem;
            }
            .nav-button {
                width: 60px;
                height: 60px;
                font-size: 0.6em;
                padding: 0.3rem;
            }
            .nav-button .icon {
                font-size: 1.4em;
                margin-bottom: 0.1em;
            }

            .record-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.6rem 1rem;
            }
            .record-item span {
                font-size: 0.9em;
            }
            .record-item .date, .record-item .count {
                flex-basis: 100%;
                text-align: left;
            }
            .record-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
                gap: 0.3rem;
            }
            .btn-action {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }

            .stats-section {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: 0.5rem;
                margin-top: 1.5rem;
            }
            .stat-card {
                padding: 0.5rem;
            }
            .stat-card h3 {
                font-size: 0.9em;
                margin-bottom: 0.3rem;
            }
            .stat-card p {
                font-size: 1.3em;
            }

            .count-input-group {
                flex-wrap: nowrap;
                gap: 0.3rem;
            }
            .count-input-group input[type="number"] {
                width: auto;
                max-width: 80px;
            }
            .count-input-group .count-button {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }

            .calendar {
                gap: 2px;
            }
            .calendar-header {
                font-size: 1em;
                margin-bottom: 0.8rem;
            }
            .calendar-header button {
                padding: 0.4rem 0.7rem;
                font-size: 0.9em;
            }
            .day-name, .day-cell {
                font-size: 0.75em;
                padding: 0.3rem 0;
                min-height: 35px;
            }

            .chart-container {
                margin-top: 1.5rem;
            }
            #dailyChart, #weeklyChart, #monthlyChart {
                height: 250px;
                padding: 0.8rem;
            }
            .chart-main-title {
                font-size: 1.4em;
                margin-top: 1.5rem;
            }
            .chart-container h2 {
                font-size: 1em;
                margin-top: 0.8rem;
            }

            /* Badges Grid Styles for Mobile */
            .badges-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            .badge-card {
                padding: 0.6rem;
                min-height: 100px;
            }
            .badge-card .badge-icon {
                font-size: 1.5em;
            }
            .badge-card .badge-name {
                font-size: 0.8em;
            }
            .badge-card .badge-description {
                font-size: 0.65em;
            }
            .badge-card .badge-progress {
                font-size: 0.6em;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Service Worker Registration (for PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker enregistré:', reg.scope))
                    .catch(err => console.error('Erreur SW:', err));
            });
        }
    </script>
</head>
<body>
    <h1 id="mainTitle">SmokeTrack <span class="logo">🚭</span></h1>

    <div class="nav-buttons-container">
        <button class="nav-button active" data-target="nowView">
            <span class="icon">🚀</span>
            NOW
        </button>
        <button class="nav-button" data-target="consumptionView">
            <span class="icon">🚬</span>
            Consommation
        </button>
        <button class="nav-button" data-target="calendarView">
            <span class="icon">📅</span>
            Calendrier
        </button>
        <button class="nav-button" data-target="trendsView">
            <span class="icon">📈</span>
            Tendances
        </button>
        <button class="nav-button" data-target="settingsView">
            <span class="icon">⚙️</span>
            Paramètres
        </button>
    </div>

    <div id="nowView" class="view-section active">
        <button id="addTodayCigaretteBigButton">
            <span id="bigCigaretteCountDisplay"></span>
            <span id="bigButtonText">Ajouter une cigarette</span>
        </button>
    </div>


    <div id="consumptionView" class="view-section">
        <div class="container">
            <h2>Enregistrer ou Modifier</h2>
            <form id="cigaretteForm">
                <label for="recordDate">Date</label>
                <input type="date" id="recordDate" required />

                <label for="cigaretteCount">Nombre de cigarettes</label>
                <div class="count-input-group">
                    <button type="button" id="decrementCount" class="count-button decrement">-</button>
                    <input type="number" id="cigaretteCount" min="0" value="0" required />
                    <button type="button" id="incrementCount" class="count-button">+</button>
                </div>
            </form>
        </div>
        <div class="container stats-section">
            <div class="stat-card">
                <h3>Total aujourd'hui</h3>
                <p id="totalToday">0</p>
            </div>
            <div class="stat-card">
                <h3>Objectif quotidien</h3>
                <p id="dailyGoalStatus">0</p>
            </div>
            <div class="stat-card">
                <h3>Jours sans fumer (Total)</h3>
                <p id="smokeFreeDaysCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Plus longue série sans fumer</h3>
                <p id="longestStreak">0 jours</p>
            </div>
            <div class="stat-card">
                <h3>Argent économisé aujourd'hui</h3>
                <p id="savedToday">0.00 €</p>
            </div>
            <div class="stat-card">
                <h3>Total économisé</h3>
                <p id="savedTotal">0.00 €</p>
            </div>
        </div>
        </div>

    <div id="calendarView" class="view-section">
        <div class="container">
            <h2>Calendrier de consommation</h2>
            <div id="calendarContainer">
            </div>
        </div>
    </div>

    <div id="trendsView" class="view-section">
        <h2 class="chart-main-title">Tendances de consommation journalière</h2>
        <div class="container chart-container">
            <canvas id="dailyChart"></canvas>
            <h2>Tendances journalières (30 derniers jours)</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation hebdomadaire</h2>
        <div class="container chart-container">
            <canvas id="weeklyChart"></canvas>
            <h2>Tendances hebdomadaires</h2>
        </div>

        <h2 class="chart-main-title">Tendances de consommation mensuelle</h2>
        <div class="container chart-container">
            <canvas id="monthlyChart"></canvas>
            <h2>Tendances mensuelles</h2>
        </div>
    </div>

    <div id="settingsView" class="view-section">
        <div class="container">
            <h2>Paramètres de l'application</h2>

            <h3>Objectif de réduction</h3>
            <label for="dailyGoalInput">Mon objectif quotidien de cigarettes</label>
            <div class="count-input-group">
                <button type="button" id="decrementGoal" class="count-button decrement">-</button>
                <input type="number" id="dailyGoalInput" min="0" value="0" />
                <button type="button" id="incrementGoal" class="count-button">+</button>
            </div>

            <h3 style="margin-top: 2rem;">Date de début de l'objectif</h3>
            <label for="startDateInput">Depuis quand avez-vous commencé votre objectif ?</label>
            <input type="date" id="startDateInput" />

            <h3 style="margin-top: 2rem;">Calcul des économies</h3>
            <label for="packPrice">Prix moyen d'un paquet (€)</label>
            <input type="number" id="packPrice" min="0" step="0.01" value="10.00" />

            <label for="cigsPerPack">Nombre de cigarettes par paquet</label>
            <input type="number" id="cigsPerPack" min="1" value="20" />

            <label for="baselineCigarettesPerDay">Ma consommation moyenne avant de commencer (cigarettes/jour)</label>
            <input type="number" id="baselineCigarettesPerDay" min="0" value="20" />

            <h3 style="margin-top: 2rem;">Vos économies</h3>
            <div class="stats-section">
                <div class="stat-card">
                    <h3>Cette semaine</h3>
                    <p id="savedThisWeek">0.00 €</p>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">Vos badges et objectifs</h3>
            <p style="text-align: center; color: #d1d5db; font-size: 0.9em; margin-bottom: 1rem;">
                Les badges de type "Journée sans cigarette" apparaissent directement dans votre calendrier.
            </p>
            <div id="badgeDisplayArea" class="badges-grid">
                </div>

            <h3 style="margin-top: 2rem;">Gestion des données</h3>
            <button class="btn-action" id="exportData" style="background: #3b82f6;">Exporter les données</button>
            <input type="file" id="importData" accept=".json" style="display: none; margin-top: 1rem;" />
            <button class="btn-action" id="importDataButton" style="background: #22c55e;">Importer des données</button>
            <button class="btn-action" id="clearData" style="background: #ef4444; margin-top: 1rem;">Effacer toutes les données</button>
        </div>
    </div>

    <div id="snackbar" class="snackbar"></div>

    <script>
        const cigaretteForm = document.getElementById('cigaretteForm');
        const recordDateInput = document.getElementById('recordDate');
        const cigaretteCountInput = document.getElementById('cigaretteCount');
        const mainTitle = document.getElementById('mainTitle');
        const incrementButton = document.getElementById('incrementCount');
        const decrementButton = document.getElementById('decrementCount');

        // New elements for NOW tab
        const addTodayCigaretteBigButton = document.getElementById('addTodayCigaretteBigButton');
        const bigCigaretteCountDisplay = document.getElementById('bigCigaretteCountDisplay');


        // Stats elements
        const totalTodayElement = document.getElementById('totalToday');
        const dailyGoalStatusElement = document.getElementById('dailyGoalStatus');
        const smokeFreeDaysCountElement = document.getElementById('smokeFreeDaysCount');
        const longestStreakElement = document.getElementById('longestStreak');
        const savedTodayElement = document.getElementById('savedToday');
        const savedTotalElement = document.getElementById('savedTotal');
        const savedThisWeekElement = document.getElementById('savedThisWeek'); // In settings

        // Settings elements
        const dailyGoalInput = document.getElementById('dailyGoalInput');
        const incrementGoalButton = document.getElementById('incrementGoal');
        const decrementGoalButton = document.getElementById('decrementGoal');
        const startDateInput = document.getElementById('startDateInput');
        const packPriceInput = document.getElementById('packPrice');
        const cigsPerPackInput = document.getElementById('cigsPerPack');
        const baselineCigarettesPerDayInput = document.getElementById('baselineCigarettesPerDay');

        // Data management buttons
        const exportDataButton = document.getElementById('exportData');
        const importDataInput = document.getElementById('importData');
        const importDataButton = document.getElementById('importDataButton');
        const clearDataButton = document.getElementById('clearData');

        // Navigation elements
        const navButtons = document.querySelectorAll('.nav-button');
        const viewSections = document.querySelectorAll('.view-section');
        const snackbar = document.getElementById('snackbar');

        // Calendar elements
        const calendarContainer = document.getElementById('calendarContainer');
        let currentCalendarDate = new Date();

        // Badge elements
        const badgeDisplayArea = document.getElementById('badgeDisplayArea');
        let earnedBadges = JSON.parse(localStorage.getItem('earnedBadges')) || [];
        let dailyBadgesEarned = JSON.parse(localStorage.getItem('dailyBadgesEarned')) || []; // For daily repeatable badges

        const badgeDefinitions = [
            { id: 'first_day_smoke_free', name: 'Premier Jour Libre !', description: 'Vous avez passé 24 heures sans fumer.', type: 'milestone', category: 'longestStreak', threshold: 1, icon: '🌟' },
            { id: 'one_week_smoke_free', name: 'Une Semaine sans Fumer !', description: '7 jours consécutifs sans cigarette.', type: 'milestone', category: 'longestStreak', threshold: 7, icon: '✨' },
            { id: 'one_month_smoke_free', name: 'Un Mois sans Fumer !', description: '30 jours consécutifs sans cigarette.', type: 'milestone', category: 'longestStreak', threshold: 30, icon: '🏅' },
            { id: '100_days_smoke_free', name: 'Le Centenaire Sans Fumée !', description: '100 jours consécutifs sans cigarette. Bravo !', type: 'milestone', category: 'longestStreak', threshold: 100, icon: '🏆' },
            { id: 'saved_10_euro', name: '10€ Économisés', description: 'Vous avez économisé 10€ en ne fumant pas.', type: 'milestone', category: 'savedMoney', threshold: 10, icon: '💰' },
            { id: 'saved_50_euro', name: '50€ Économisés', description: 'Vous avez économisé 50€ !', type: 'milestone', category: 'savedMoney', threshold: 50, icon: '💸' },
            { id: 'saved_100_euro', name: '100€ Économisés !', description: 'C\'est 100€ de plus dans votre poche !', type: 'milestone', category: 'savedMoney', threshold: 100, icon: '💎' },
            { id: 'daily_smoke_free', name: 'Journée sans cigarette', description: 'Vous avez passé la journée sans fumer.', type: 'daily', icon: '✅' }, // NEW Daily badge
        ];


        let records = [];

        // Chart instances
        let dailyChartInstance = null;
        let weeklyChartInstance = null;
        let monthlyChartInstance = null;

        // Data holders for charts
        let chartData = {
            dailyLabels: [], dailyCounts: [],
            weeklyLabels: [], weeklyCounts: [],
            monthlyLabels: [], monthlyCounts: []
        };

        // Settings variables (loaded from localStorage)
        let dailyGoal = parseInt(localStorage.getItem('dailyCigaretteGoal')) || 0;
        let startDate = localStorage.getItem('startDate') || formatLocalDateToISOString(new Date());
        let packPrice = parseFloat(localStorage.getItem('packPrice')) || 10.00;
        let cigsPerPack = parseInt(localStorage.getItem('cigsPerPack')) || 20;
        let baselineCigarettesPerDay = parseInt(localStorage.getItem('baselineCigarettesPerDay')) || 20;

        // --- Helper functions for date handling consistency ---
        // Parses a 'YYYY-MM-DD' string into a Date object at the start of that day in LOCAL timezone.
        function parseISODateStringToLocalDate(isoDateString) {
            const [year, month, day] = isoDateString.split('-').map(Number);
            return new Date(year, month - 1, day); // Month is 0-indexed
        }

        // Formats a Date object into a 'YYYY-MM-DD' string using its LOCAL year, month, and day.
        function formatLocalDateToISOString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        // --- End Helper functions ---

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function showSnackbar(message, duration = 3000) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, duration);
        }

        function loadRecords() {
            const storedRecords = JSON.parse(localStorage.getItem('smokeTrackRecords')) || [];
            records = [];
            let changed = false;

            // Ensure all records have an ID and filter out 0-count records if they don't have existing IDs
            storedRecords.forEach(record => {
                if (!record.id) {
                    record.id = generateUniqueId();
                    changed = true;
                }
                // Keep all records, even with count 0, as they are needed for smoke-free day tracking
                records.push(record);
            });

            if (changed) {
                localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            }

            // Sort records by date descending
            records.sort((a, b) => parseISODateStringToLocalDate(b.date) - parseISODateStringToLocalDate(a.date));

            // Load daily badges
            dailyBadgesEarned = JSON.parse(localStorage.getItem('dailyBadgesEarned')) || [];


            updateStatistics();
            checkAndAwardBadges(); // Check for milestone badges after stats are updated
            prepareChartData(); // Prepare chart data after records are loaded/updated
            renderCalendar(currentCalendarDate); // Render calendar after records and daily badges are loaded
            updateConsumptionViewForSelectedDate(); // Update consumption view with current date's record
            updateBigButtonDisplay(); // Update the display on the NOW button
        }

        // Removed displayRecords() as the record list is removed from the UI.

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const d = parseISODateStringToLocalDate(dateStr);
            return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function saveOrUpdateConsumption() {
            const date = recordDateInput.value;
            const count = parseInt(cigaretteCountInput.value, 10);

            if (!date) {
                console.error('Date manquante. Impossible d\'enregistrer.');
                showSnackbar('Date manquante.', 2000);
                return;
            }
            if (isNaN(count) || count < 0) {
                console.error('Nombre de cigarettes invalide. Impossible d\'enregistrer.');
                showSnackbar('Nombre de cigarettes invalide.', 2000);
                return;
            }

            const existingRecordIndex = records.findIndex(r => r.date === date);
            let message = '';

            if (existingRecordIndex !== -1) {
                records[existingRecordIndex] = { ...records[existingRecordIndex], count: count };
                message = 'Consommation mise à jour.';
            } else {
                records.push({ id: generateUniqueId(), date: date, count: count });
                message = 'Consommation ajoutée.';
            }

            localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            loadRecords(); // Reload to update list, stats, and charts
            showSnackbar(message);
        }

        // Event listeners for consumption input (standard +- buttons)
        incrementButton.addEventListener('click', () => {
            cigaretteCountInput.value = parseInt(cigaretteCountInput.value, 10) + 1;
            saveOrUpdateConsumption();
        });

        decrementButton.addEventListener('click', () => {
            const currentCount = parseInt(cigaretteCountInput.value, 10);
            if (currentCount > 0) {
                cigaretteCountInput.value = currentCount - 1;
            } else if (currentCount === 0) {
                 cigaretteCountInput.value = 0; // Prevent going below 0
            }
            saveOrUpdateConsumption();
        });

        cigaretteCountInput.addEventListener('input', () => {
             const value = cigaretteCountInput.value;
            if (value === '' || value === null || isNaN(parseInt(value, 10))) {
                // Allow empty string temporarily for user input, don't save.
                // Or if it's an invalid number (e.g., just "-")
                return;
            }
            const count = parseInt(value, 10);
            if (!isNaN(count) && count >= 0) {
                saveOrUpdateConsumption();
            }
        });

        // NEW: Big "Add Cigarette Today" button logic for NOW tab
        addTodayCigaretteBigButton.addEventListener('click', () => {
            const todayISO = formatLocalDateToISOString(new Date());
            const existingRecord = records.find(r => r.date === todayISO);
            const currentCount = existingRecord ? existingRecord.count : 0;

            const newCount = currentCount + 1;

            // Find the record for today, or create a new one if it doesn't exist
            const recordIndex = records.findIndex(r => r.date === todayISO);
            if (recordIndex !== -1) {
                records[recordIndex].count = newCount;
            } else {
                records.push({ id: generateUniqueId(), date: todayISO, count: newCount });
            }

            localStorage.setItem('smokeTrackRecords', JSON.stringify(records));
            loadRecords(); // Reload to update all stats, history, calendar, and NOW button display
            showSnackbar('Cigarette ajoutée pour aujourd\'hui !');
        });

        // NEW: Function to update the display on the big NOW button
        function updateBigButtonDisplay() {
            const todayISO = formatLocalDateToISOString(new Date());
            const existingRecord = records.find(r => r.date === todayISO);
            const count = existingRecord ? existingRecord.count : 0;

            if (count > 0) {
                bigCigaretteCountDisplay.textContent = count;
                document.getElementById('bigButtonText').textContent = 'cigarettes aujourd\'hui';
            } else {
                bigCigaretteCountDisplay.textContent = ''; // Display nothing if count is 0
                document.getElementById('bigButtonText').textContent = 'Ajouter une cigarette';
            }
        }


        function updateConsumptionViewForSelectedDate() {
            const selectedDate = recordDateInput.value;
            const existingRecord = records.find(r => r.date === selectedDate);
            cigaretteCountInput.value = existingRecord ? existingRecord.count : 0;
        }

        recordDateInput.addEventListener('change', updateConsumptionViewForSelectedDate);

        // Settings functions
        function loadSettings() {
            dailyGoal = parseInt(localStorage.getItem('dailyCigaretteGoal')) || 0;
            startDate = localStorage.getItem('startDate') || formatLocalDateToISOString(new Date());
            packPrice = parseFloat(localStorage.getItem('packPrice')) || 10.00;
            cigsPerPack = parseInt(localStorage.getItem('cigsPerPack')) || 20;
            baselineCigarettesPerDay = parseInt(localStorage.getItem('baselineCigarettesPerDay')) || 20;

            dailyGoalInput.value = dailyGoal;
            startDateInput.value = startDate;
            packPriceInput.value = packPrice.toFixed(2);
            cigsPerPackInput.value = cigsPerPack;
            baselineCigarettesPerDayInput.value = baselineCigarettesPerDay;
        }

        function saveSettings() {
            dailyGoal = parseInt(dailyGoalInput.value, 10);
            startDate = startDateInput.value;
            packPrice = parseFloat(packPriceInput.value);
            cigsPerPack = parseInt(cigsPerPackInput.value, 10);
            baselineCigarettesPerDay = parseInt(baselineCigarettesPerDayInput.value, 10);

            localStorage.setItem('dailyCigaretteGoal', dailyGoal);
            localStorage.setItem('startDate', startDate);
            localStorage.setItem('packPrice', packPrice);
            localStorage.setItem('cigsPerPack', cigsPerPack);
            localStorage.setItem('baselineCigarettesPerDay', baselineCigarettesPerDay);

            updateStatistics();
            showSnackbar('Paramètres sauvegardés.');
            displayBadges(); // Refresh badge display in case thresholds were met with new settings
        }

        incrementGoalButton.addEventListener('click', () => {
            dailyGoalInput.value = parseInt(dailyGoalInput.value, 10) + 1;
            saveSettings();
        });

        decrementGoalButton.addEventListener('click', () => {
            const currentGoal = parseInt(dailyGoalInput.value, 10);
            if (currentGoal > 0) { // Allow goal to be 0
                dailyGoalInput.value = currentGoal - 1;
            } else if (currentGoal === 0 && dailyGoalInput.min === '0') {
                dailyGoalInput.value = 0; // Ensure it stays 0 if min is 0
            }
            saveSettings();
        });

        startDateInput.addEventListener('change', saveSettings);

        packPriceInput.addEventListener('input', () => {
            const value = packPriceInput.value;
            if (value === '' || isNaN(parseFloat(value))) return;
            saveSettings();
        });
        cigsPerPackInput.addEventListener('input', () => {
            const value = cigsPerPackInput.value;
            if (value === '' || isNaN(parseInt(value, 10))) return;
            saveSettings();
        });
        baselineCigarettesPerDayInput.addEventListener('input', () => {
            const value = baselineCigarettesPerDayInput.value;
            if (value === '' || isNaN(parseInt(value, 10))) return;
            saveSettings();
        });


        function updateStatistics() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            let totalToday = 0;
            let totalThisWeek = 0;
            let totalThisMonth = 0; // Not currently displayed, but calculated
            let grandTotal = 0; // Not currently displayed, but calculated

            const costPerCigarette = (cigsPerPack > 0) ? (packPrice / cigsPerPack) : 0;

            const userStartDate = parseISODateStringToLocalDate(startDate);
            userStartDate.setHours(0, 0, 0, 0);

            let smokeFreeDays = 0;
            let currentStreak = 0;
            let longestStreak = 0;

            // Calculate smoke-free days and longest streak
            for (let d = new Date(userStartDate); d <= now; d.setDate(d.getDate() + 1)) {
                const dayISO = formatLocalDateToISOString(d);
                const recordForDay = records.find(r => r.date === dayISO);

                if (!recordForDay || recordForDay.count === 0) {
                    smokeFreeDays++;
                    currentStreak++;
                } else {
                    longestStreak = Math.max(longestStreak, currentStreak);
                    currentStreak = 0;
                }
            }
            longestStreak = Math.max(longestStreak, currentStreak); // Final check for streak ending today

            // Calculate total cigarettes not smoked ever
            let totalCigsNotSmokedEver = 0;
            for (let d = new Date(userStartDate); d <= now; d.setDate(d.getDate() + 1)) {
                const dayISO = formatLocalDateToISOString(d);
                const recordForDay = records.find(r => r.date === dayISO);
                const actualCigs = recordForDay ? recordForDay.count : 0;
                totalCigsNotSmokedEver += Math.max(0, baselineCigarettesPerDay - actualCigs);
            }


            // Process records for daily, weekly, monthly totals
            records.forEach(record => {
                const recordDate = parseISODateStringToLocalDate(record.date);
                recordDate.setHours(0, 0, 0, 0);

                grandTotal += record.count;

                if (recordDate.toDateString() === now.toDateString()) {
                    totalToday += record.count;
                }

                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday as first day of week
                startOfWeek.setHours(0, 0, 0, 0);

                if (recordDate >= startOfWeek && recordDate <= now) {
                    totalThisWeek += record.count;
                }

                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                if (recordDate >= startOfMonth && recordDate <= now) {
                    totalThisMonth += record.count;
                }
            });

            // Calculate saved amounts
            const savedTodayCigs = Math.max(0, baselineCigarettesPerDay - totalToday);
            const savedTodayAmount = (savedTodayCigs * costPerCigarette).toFixed(2);

            let savedThisWeekCigs = 0;
            const startOfWeekForSaved = new Date(now);
            startOfWeekForSaved.setDate(now.getDate() - now.getDay()); // Sunday as first day of week
            startOfWeekForSaved.setHours(0,0,0,0);

            for (let d = new Date(startOfWeekForSaved); d <= now; d.setDate(d.getDate() + 1)) {
                const dayISO = formatLocalDateToISOString(d);
                const recordForDay = records.find(r => r.date === dayISO);
                savedThisWeekCigs += Math.max(0, baselineCigarettesPerDay - (recordForDay ? recordForDay.count : 0));
            }
            const savedThisWeekAmount = (savedThisWeekCigs * costPerCigarette).toFixed(2);

            const savedTotalAmount = (totalCigsNotSmokedEver * costPerCigarette).toFixed(2);


            // Update elements
            totalTodayElement.textContent = totalToday;
            dailyGoalStatusElement.textContent = `${totalToday} / ${dailyGoal} ${totalToday <= dailyGoal ? '✔️' : '❌'}`;
            dailyGoalStatusElement.style.color = totalToday <= dailyGoal ? '#4CAF50' : '#ef4444';
            smokeFreeDaysCountElement.textContent = smokeFreeDays;
            longestStreakElement.textContent = `${longestStreak} jours`;
            savedTodayElement.textContent = `${savedTodayAmount} €`;
            savedTotalElement.textContent = `${savedTotalAmount} €`;
            savedThisWeekElement.textContent = `${savedThisWeekAmount} €`;

            // Call daily badge update logic
            const todayRecord = records.find(r => r.date === formatLocalDateToISOString(now));
            const todayCount = todayRecord ? todayRecord.count : 0;
            updateDailyBadgeStatus(formatLocalDateToISOString(now), todayCount === 0);
        }

        // Handles milestone badges (awarded once)
        function checkAndAwardBadges() {
            let newBadgesEarned = false;
            const currentSavedTotal = parseFloat(savedTotalElement.textContent.replace(' €', '')) || 0;
            const currentLongestStreak = parseInt(longestStreakElement.textContent.replace(' jours', '')) || 0;

            badgeDefinitions.filter(b => b.type === 'milestone').forEach(badge => {
                if (!earnedBadges.some(b => b.id === badge.id)) { // Check if not already earned
                    let conditionMet = false;
                    if (badge.category === 'longestStreak' && currentLongestStreak >= badge.threshold) {
                        conditionMet = true;
                    } else if (badge.category === 'savedMoney' && currentSavedTotal >= badge.threshold) {
                        conditionMet = true;
                    }

                    if (conditionMet) {
                        earnedBadges.push({ id: badge.id, name: badge.name, description: badge.description, icon: badge.icon, timestamp: Date.now() });
                        newBadgesEarned = true;
                        showSnackbar(`Badge débloqué : ${badge.name}! ${badge.icon}`);
                    }
                }
            });

            if (newBadgesEarned) {
                localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));
                displayBadges();
            }
        }

        // Handles daily badges (can be awarded multiple times for different days)
        function updateDailyBadgeStatus(dateISO, isSmokeFree) {
            const dailySmokeFreeBadge = badgeDefinitions.find(b => b.id === 'daily_smoke_free');
            if (!dailySmokeFreeBadge) return;

            const existingEntryIndex = dailyBadgesEarned.findIndex(entry => entry.date === dateISO && entry.badgeId === dailySmokeFreeBadge.id);

            if (isSmokeFree) {
                if (existingEntryIndex === -1) { // If not already recorded for this day
                    dailyBadgesEarned.push({ date: dateISO, badgeId: dailySmokeFreeBadge.id, icon: dailySmokeFreeBadge.icon });
                    localStorage.setItem('dailyBadgesEarned', JSON.stringify(dailyBadgesEarned));
                    renderCalendar(currentCalendarDate); // Refresh calendar to show badge
                }
            } else {
                if (existingEntryIndex !== -1) { // If recorded, but now smoked
                    dailyBadgesEarned.splice(existingEntryIndex, 1);
                    localStorage.setItem('dailyBadgesEarned', JSON.stringify(dailyBadgesEarned));
                    renderCalendar(currentCalendarDate); // Refresh calendar to remove badge
                }
            }
        }


        function displayBadges() {
            badgeDisplayArea.innerHTML = '';
            const currentSavedTotal = parseFloat(savedTotalElement.textContent.replace(' €', '')) || 0;
            const currentLongestStreak = parseInt(longestStreakElement.textContent.replace(' jours', '')) || 0;

            const milestoneBadges = badgeDefinitions.filter(b => b.type === 'milestone');

            if (milestoneBadges.length === 0) {
                badgeDisplayArea.innerHTML = '<p style="text-align: center; color: #d1d5db;">Aucun badge jalon défini.</p>';
                return;
            }

            // Sort earned badges by timestamp for display
            const sortedEarnedBadges = [...earnedBadges].sort((a, b) => a.timestamp - b.timestamp);
            const earnedBadgeIds = new Set(sortedEarnedBadges.map(b => b.id));

            // Display earned milestone badges first
            sortedEarnedBadges.forEach(badgeDef => {
                // Ensure it's a milestone badge from definitions
                const originalBadge = milestoneBadges.find(b => b.id === badgeDef.id);
                if (originalBadge) {
                    const badgeCard = document.createElement('div');
                    badgeCard.className = 'badge-card';

                    badgeCard.innerHTML = `
                        <div class="badge-icon">${originalBadge.icon}</div>
                        <div class="badge-name">${originalBadge.name}</div>
                        <div class="badge-description">${originalBadge.description}</div>
                    `;
                    badgeDisplayArea.appendChild(badgeCard);
                }
            });

            // Display unearned milestone badges greyed out with progress
            milestoneBadges.forEach(badgeDef => {
                if (!earnedBadgeIds.has(badgeDef.id)) {
                    const badgeCard = document.createElement('div');
                    badgeCard.className = 'badge-card';
                    let progressText = '';
                    let badgeStyle = 'filter: grayscale(100%) opacity(0.6); -webkit-filter: grayscale(100%) opacity(0.6);';

                    if (badgeDef.category === 'longestStreak') {
                        progressText = `Progrès : ${currentLongestStreak} / ${badgeDef.threshold} jours`;
                    } else if (badgeDef.category === 'savedMoney') {
                        progressText = `Progrès : ${currentSavedTotal.toFixed(2)} / ${badgeDef.threshold.toFixed(2)} €`;
                    }

                    badgeCard.style.cssText = badgeStyle;

                    badgeCard.innerHTML = `
                        <div class="badge-icon">${badgeDef.icon}</div>
                        <div class="badge-name">${badgeDef.name}</div>
                        <div class="badge-description">${badgeDef.description}</div>
                        ${progressText ? `<div class="badge-progress">${progressText}</div>` : ''}
                    `;
                    badgeDisplayArea.appendChild(badgeCard);
                }
            });
        }


        function prepareChartData() {
            const dailyData = {};
            const weeklyData = {};
            const monthlyData = {};

            records.forEach(record => {
                const date = parseISODateStringToLocalDate(record.date);
                date.setHours(0, 0, 0, 0);

                const dayKey = formatLocalDateToISOString(date);
                dailyData[dayKey] = (dailyData[dayKey] || 0) + record.count;

                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay());
                const weekKey = formatLocalDateToISOString(startOfWeek);
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + record.count;

                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + record.count;
            });

            const limitDays = 30;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dailyChartLabels = [];
            const dailyChartData = [];

            for (let i = limitDays - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateKey = formatLocalDateToISOString(d);
                const displayDate = formatDate(dateKey).replace(` ${d.getFullYear()}`, '');

                dailyChartLabels.push(displayDate);
                dailyChartData.push(dailyData[dateKey] || 0);
            }

            const sortedWeeklyLabels = Object.keys(weeklyData).sort();
            const readableWeeklyLabels = sortedWeeklyLabels.map(d => {
                const startDate = parseISODateStringToLocalDate(d);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                return `${formatDate(formatLocalDateToISOString(startDate)).slice(0, -5)} - ${formatDate(formatLocalDateToISOString(endDate)).slice(0, -5)}`;
            });
            const sortedWeeklyCounts = sortedWeeklyLabels.map(label => weeklyData[label]);

            const sortedMonthlyLabels = Object.keys(monthlyData).sort();
            const readableMonthlyLabels = sortedMonthlyLabels.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
            });
            const sortedMonthlyCounts = sortedMonthlyLabels.map(label => monthlyData[label]);

            chartData.dailyLabels = dailyChartLabels;
            chartData.dailyCounts = dailyChartData;
            chartData.weeklyLabels = readableWeeklyLabels;
            chartData.weeklyCounts = sortedWeeklyCounts;
            chartData.monthlyLabels = readableMonthlyLabels;
            chartData.monthlyCounts = sortedMonthlyCounts;
        }

        function renderDailyChart() {
            if (dailyChartInstance) dailyChartInstance.destroy();
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: chartData.dailyLabels,
                    datasets: [{
                        label: 'Cigarettes par jour',
                        data: chartData.dailyCounts,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderWeeklyChart() {
            if (weeklyChartInstance) weeklyChartInstance.destroy();
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChartInstance = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: chartData.weeklyLabels,
                    datasets: [{
                        label: 'Cigarettes par semaine',
                        data: chartData.weeklyCounts,
                        backgroundColor: 'rgba(251, 191, 36, 0.7)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderMonthlyChart() {
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: chartData.monthlyLabels,
                    datasets: [{
                        label: 'Cigarettes par mois',
                        data: chartData.monthlyCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -1,
                            ticks: { color: '#d1d5db' },
                            grid: { color: '#4B5563' }
                        },
                        x: { ticks: { color: '#d1d5db', maxTicksLimit: 10, autoSkip: true }, grid: { color: '#4B5563' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function renderCalendar(date) {
            calendarContainer.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // Adjust to start on Monday (0=Mon, 6=Sun)

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const dayNames = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];

            const headerDiv = document.createElement('div');
            headerDiv.className = 'calendar-header';
            headerDiv.innerHTML = `
                <button id="prevMonth">←</button>
                <span>${monthNames[month]} ${year}</span>
                <button id="nextMonth">→</button>
            `;
            calendarContainer.appendChild(headerDiv);

            document.getElementById('prevMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate);
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate);
            });

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'calendar';
            calendarContainer.appendChild(calendarGrid);

            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = 'day-name';
                dayNameDiv.textContent = day;
                calendarGrid.appendChild(dayNameDiv);
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell inactive';
                calendarGrid.appendChild(emptyCell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                const dayNumSpan = document.createElement('span');
                dayNumSpan.textContent = i;
                dayCell.appendChild(dayNumSpan);
                dayCell.className = 'day-cell';

                const currentDay = new Date(year, month, i);
                currentDay.setHours(0, 0, 0, 0);
                const currentDayISO = formatLocalDateToISOString(currentDay);

                const recordForDay = records.find(r => r.date === currentDayISO);

                if (recordForDay && recordForDay.count > 0) {
                    dayCell.classList.add('smoked');
                } else if (currentDay <= today) { // If it's a past or current date with no smoking
                    dayCell.classList.add('no-smoke');
                }

                if (currentDay.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }

                // Check for daily badges for this date
                const dailyBadgeEntry = dailyBadgesEarned.find(entry => entry.date === currentDayISO && entry.badgeId === 'daily_smoke_free');
                if (dailyBadgeEntry) {
                    const badgeSmileySpan = document.createElement('span');
                    badgeSmileySpan.className = 'badge-smiley';
                    badgeSmileySpan.textContent = dailyBadgeEntry.icon;
                    dayCell.appendChild(badgeSmileySpan);
                }

                dayCell.addEventListener('click', () => {
                    recordDateInput.value = currentDayISO;
                    updateConsumptionViewForSelectedDate();
                    showView('consumptionView');
                });

                calendarGrid.appendChild(dayCell);
            }
        }


        // Navigation logic
        function showView(viewId) {
            viewSections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.target === viewId) {
                    button.classList.add('active');
                }
            });

            if (viewId === 'trendsView') {
                renderDailyChart();
                renderWeeklyChart();
                renderMonthlyChart();
            } else {
                if (dailyChartInstance) dailyChartInstance.destroy();
                if (weeklyChartInstance) weeklyChartInstance.destroy();
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                dailyChartInstance = null;
                weeklyChartInstance = null;
                monthlyChartInstance = null;
            }

            if (viewId === 'calendarView') {
                renderCalendar(currentCalendarDate);
            }

            if (viewId === 'settingsView') {
                loadSettings();
                displayBadges();
            }

            if (viewId === 'nowView') {
                updateBigButtonDisplay(); // Make sure the big button reflects current count
            }

            if (viewId === 'consumptionView') {
                 // Ensure record date is set to today's date for quick editing, or keep last selected date
                 recordDateInput.value = formatLocalDateToISOString(new Date());
                 updateConsumptionViewForSelectedDate();
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.target);
            });
        });

        // Data Management functions
        exportDataButton.addEventListener('click', () => {
            const data = {
                records: records,
                settings: {
                    dailyCigaretteGoal: dailyGoal,
                    startDate: startDate,
                    packPrice: packPrice,
                    cigsPerPack: cigsPerPack,
                    baselineCigarettesPerDay: baselineCigarettesPerDay
                },
                earnedBadges: earnedBadges,
                dailyBadgesEarned: dailyBadgesEarned
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'smokeTrack_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSnackbar('Données exportées avec succès.');
        });

        importDataButton.addEventListener('click', () => {
            importDataInput.click();
        });

        importDataInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.records && Array.isArray(importedData.records)) {
                        records = importedData.records;
                        localStorage.setItem('smokeTrackRecords', JSON.stringify(records));

                        if (importedData.settings) {
                            localStorage.setItem('dailyCigaretteGoal', importedData.settings.dailyCigaretteGoal || 0);
                            localStorage.setItem('startDate', importedData.settings.startDate || formatLocalDateToISOString(new Date()));
                            localStorage.setItem('packPrice', importedData.settings.packPrice || 10.00);
                            localStorage.setItem('cigsPerPack', importedData.settings.cigsPerPack || 20);
                            localStorage.setItem('baselineCigarettesPerDay', importedData.settings.baselineCigarettesPerDay || 20);
                            loadSettings();
                        }
                        if (importedData.earnedBadges && Array.isArray(importedData.earnedBadges)) {
                            earnedBadges = importedData.earnedBadges;
                            localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));
                        }
                        if (importedData.dailyBadgesEarned && Array.isArray(importedData.dailyBadgesEarned)) {
                            dailyBadgesEarned = importedData.dailyBadgesEarned;
                            localStorage.setItem('dailyBadgesEarned', JSON.stringify(dailyBadgesEarned));
                        }


                        loadRecords();
                        showSnackbar('Données importées avec succès.');
                    } else {
                        throw new Error('Format de données invalide.');
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'importation des données:', error);
                    showSnackbar('Erreur lors de l\'importation des données: ' + error.message, 5000);
                } finally {
                    importDataInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        clearDataButton.addEventListener('click', () => {
            if (confirm('Êtes-vous sûr de vouloir EFFACER TOUTES VOS DONNÉES ? Cette action est irréversible.')) {
                localStorage.removeItem('smokeTrackRecords');
                localStorage.removeItem('dailyCigaretteGoal');
                localStorage.removeItem('startDate');
                localStorage.removeItem('packPrice');
                localStorage.removeItem('cigsPerPack');
                localStorage.removeItem('baselineCigarettesPerDay');
                localStorage.removeItem('earnedBadges');
                localStorage.removeItem('dailyBadgesEarned'); // Clear daily badges too

                records = [];
                earnedBadges = [];
                dailyBadgesEarned = []; // Reset daily badges
                loadRecords();
                loadSettings();
                showSnackbar('Toutes les données ont été effacées.');
            }
        });


        // Set current date on load
        recordDateInput.value = formatLocalDateToISOString(new Date());

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadRecords();
            showView('nowView'); // Show NOW view by default
        });

    </script>
</body>
</html>